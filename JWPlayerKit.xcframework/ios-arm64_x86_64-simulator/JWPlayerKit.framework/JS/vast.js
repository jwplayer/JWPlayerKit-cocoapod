!function(){"use strict";const e="vast",t="googima",i="freewheel",s="paused",a="playing",r="fullscreen",n="volume",l="mute",o="resize",d="viewable",h="clickthrough",c="external",p=c,u="[ERRORCODE]",m="[GDPRCONSENT]",g="[REGULATIONS]",y="time",f=5e3,v="adBreakIgnored",P="__jwpseg__",A="instream",k="article",w={[[A]]:1,[["banner"]]:2,[[k]]:3,[["feed"]]:4,[["floating"]]:5,[["interstitial"]]:5,[["slider"]]:5},b="adError",E="adLoadedXML",I="adItem",_="mediaLoaded",T="adPlayComplete",C="adRequestedContentResume",x="-1",S="vmap",R="click",j="play",O="error",M="complete",B="adImpression",V="adError",L="adPodError",H="adStarted",F="adComplete",D="adClick",N="adSkipped",q="adMeta",U="adPlay",Q="adPause",$=[B,V,L],X=[H,F,B,D,N,V,U,Q,q],W=(e,t)=>({begin:e._offSet,text:t,cueType:"ads",adId:e.adBreakId});class z{constructor(e,t,i,s){this.client=s,this.player=e,this.pluginConfig=t,this.div=i,this.utils=this.player.utils,this.playerConfig=this.player.getConfig(),this.playlistItemManager=null,this.playerKey=this.playerConfig.key,this.casting=!1,this.player.pauseAd=this.pauseAd.bind(this),this.player.skipAd=this.skipAd.bind(this),this.player.skipAdBreak=this.skipAdBreak.bind(this),this.destroyAdsManager=this.destroyAdsManager.bind(this),this.handleDependencyError=this.handleDependencyError.bind(this),this.sendCues=this.sendCues.bind(this)}lateInitAfterReady(){this.onReady();const e=this.player.getPlaylistItem();e&&this.onPlaylistItemCallback({item:e,index:this.player.getPlaylistIndex()})}onReady(){throw new Error("Not implemented.")}onPlaylistItemCallback(){throw new Error("Not implemented.")}destroyAdsManager(){this.playlistItemManager&&(this.playlistItemManager.destroy(),this.playlistItemManager=null)}handleDependencyError(e,t){this.destroyAdsManager(),this.player.off(null,null,this),this.client===i&&(this.player.playAd=this.utils.noop),this.player.trigger(b,{id:x,client:this.client,message:e,code:900,adErrorCode:t,tag:""})}pauseAd(e,t=null){this.playlistItemManager&&(e?this.playlistItemManager.pause(t||{}):this.playlistItemManager.resume(t||{}))}skipAd(){var e;null!=this&&null!=(e=this.playlistItemManager)&&e.skipAd&&this.playlistItemManager.skipAd()}skipAdBreak(){var e;null!=this&&null!=(e=this.playlistItemManager)&&e.skipAdBreak&&this.playlistItemManager.skipAdBreak()}sendCues(e,t){const i=e.getMidRolls(),s=[];e.preRoll&&s.push(W(e.preRoll,t)),i.length&&i.forEach((e=>{"nonlinear"!==e._type&&s.push(W(e,t))})),e.postRoll&&s.push(W(e.postRoll,t)),this.player.addCues(s)}resetCues(){const e=this.player.getCues().filter((e=>"ads"!==e.cueType));this.player.setCues(e)}}const J=(e,t,i)=>{const s=document.createElement("param");s.setAttribute("name",t),s.setAttribute("value",i),e.appendChild(s)};class G{constructor(e,t,i){this.debugTrackFn=e,this.div=null,this.elem=null,this.environment=t,this.utils=i}addCompanion(e,t){if(this.div=e,this.elem=document.getElementById(this.div.id),!this.elem)return!1;for(let e=0;e<t.length;e++)if(this.fitsDiv(t[e]))return this.placeCompanion(t[e]),!0;return!1}removeCompanion(){this.elem.innerHTML=""}sendPings(e){(e=e.creativeView)&&(e.forEach((e=>{(new Image).src=e})),"function"==typeof this.debugTrackFn&&this.debugTrackFn({type:"companion",data:{trackers:e}}))}placeCompanion(e){if(this.removeCompanion(),"html"===e.type){const t=document.createElement("div");t.innerHTML=e.source;const i=t.getElementsByTagName("script"),s=this.utils.scriptloader;return s&&i.length&&Array.from(i).forEach((e=>{new s(e.src).load(),e.parentElement.removeChild(e)})),this.elem.appendChild(t),void this.sendPings(e.trackers)}if("iframe"===e.type){const t=document.createElement("iframe");return t.height=this.div.height,t.width=this.div.width,t.src=e.source,t.scrolling="no",t.style.border="none",t.marginWidth=0,t.marginHeight=0,this.sendPings(e.trackers),this.elem.innerHTML="",void this.elem.appendChild(t)}if("application/x-shockwave-flash"===e.type){const t=document.createElement("object");return t.setAttribute("type","application/x-shockwave-flash"),t.setAttribute("data",e.source),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("tabindex",0),J(t,"allowfullscreen","true"),J(t,"allowscriptaccess","always"),J(t,"seamlesstabbing","true"),J(t,"wmode","opaque"),this.elem.appendChild(t),void this.sendPings(e.trackers)}const t=new Image;t.src=e.source,e.clickthrough&&(t.onclick=()=>{this.utils.openLink(e.clickthrough,"_blank",{rel:"noreferrer"})}),this.elem.innerHTML="",this.elem.appendChild(t),this.sendPings(e.trackers)}fitsDiv(e){return e.width===this.div.width&&e.height===this.div.height}}const Y='data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="%23191919"/><line stroke="%23CCC" stroke-width="6" x1="32" y1="20" x2="32" y2="44"/><line stroke="%23CCC" stroke-width="6" x1="20" y1="32" x2="44" y2="32"/></svg>';let K,Z;class ee{constructor(e,t,i,s,a){this.player=e,this.environment=e.getEnvironment(),this.div=s,this.staticURL=t,this.clickURL=i,this.loadTimer=-1,this.animationTimer=-1,this.banner=null,Object.assign(this,e.Events),this.banner=document.createElement("img"),this.banner.className="jw-banner",this.banner.id=`${this.player.id}_vast_static`,Z&&K||(Z=document.createElement("img"),Z.className="jw-vast-nonlinear-open-button",Z.src=Y,K=document.createElement("img"),K.className="jw-vast-nonlinear-close-button",K.src=Y),this.div.appendChild(Z),this.div.appendChild(this.banner),this.div.appendChild(K),this.loadTimer=setTimeout(this.imageLoadError.bind(this),a),this.banner.onerror=this.imageLoadError.bind(this),this.banner.onload=this.onLoaded.bind(this),this.banner.src=this.staticURL}onLoaded(){if(clearTimeout(this.loadTimer),0===this.banner.naturalWidth)return void this.imageLoadError();this.removeBannerEventListeners();const e=this.player.utils;e.addClass(this.div,"jw-vast-nonlinear-active"),e.style(K,{bottom:this.banner.height-8,left:this.banner.width},!0),new e.UI(this.banner).on("click",this.sendClick.bind(this)),K.onclick=K.ontouchstart=this.collapse.bind(this),Z.onclick=Z.ontouchstart=this.expand.bind(this),this.trigger(j)}imageLoadError(){clearTimeout(this.loadTimer),this.trigger(O),this.removeBanner()}sendClick(){this.trigger(R)}collapse(e){e.preventDefault(),this.player.utils.addClass(this.div,"jw-vast-nonlinear-collapsed"),this.animationTimer=setTimeout((()=>{this.remove(this.banner),this.remove(K),this.animationTimer=-1}),250)}expand(e){-1===this.animationTimer&&(e.preventDefault(),this.player.utils.removeClass(this.div,"jw-vast-nonlinear-collapsed"),this.div.appendChild(this.banner),this.div.appendChild(K))}remove(e){this.div.contains(e)&&this.div.removeChild(e)}removeBannerEventListeners(){this.banner.onload=this.banner.onerror=null}removeBanner(){this.removeBannerEventListeners(),this.remove(this.banner)}removeListeners(){clearTimeout(this.loadTimer),clearTimeout(this.animationTimer),K.onclick=K.ontouchstart=Z.onclick=Z.ontouchstart=null,this.off(),this.removeBannerEventListeners()}stop(){this.player.utils.removeClass(this.div,"jw-vast-nonlinear-active jw-vast-nonlinear-collapsed"),this.removeBanner(),this.remove(K),this.remove(Z)}}class te{constructor(e,t){this.player=e,this.div=t,this.startTime=0,this.minDur=0,this.environment=e.getEnvironment(),Object.assign(this,e.Events),this.type="static",e.on("time",this.dispatchTime,this)}playAd(e,t,i,s,a){this.minDur=this.player.utils.seconds(i),this.adTag=s,this.static&&(this.static.removeListeners(),this.static.stop()),this.player.utils.addClass(this.div,"jw-vast-nonlinear"),this.static=new ee(this.player,e,t,this.div,a),this.static.on(j,this.startAd,this),this.static.on(R,this.clickHandler,this),this.static.on(O,this.errorHandler,this)}dispatchTime(e){this.trigger(y,e)}startAd(){this.startTime=this.player.getPosition(),this.minDur>0&&(0===this.startTime?this.on(y,this.startTimingAd,this):this.on(y,this.timeAd,this)),this.sendEvent(j)}startTimingAd(e){this.startTime=e.position,this.off(y,this.startTimingAd,this),this.on(y,this.timeAd,this)}timeAd(e){e.position-this.startTime>this.minDur&&(this.off(y,this.timeAd,this),this.stop())}clickHandler(){this.sendEvent(R)}errorHandler(){this.sendEvent(O)}sendEvent(e,t){(t=t||{}).tag=t.tag||this.adTag,this.trigger(e,t)}removeEvents(){this.off()}getState(){return a}stop(){this.startTime&&this.static&&(this.startTime=0,this.minDur=0,this.off(y,this.startTimingAd,this),this.off(y,this.timeAd,this),this.static.removeListeners(),this.static.stop(),this.sendEvent(M))}pause(){}destroy(){this.off(),this.player.off("time",this.dispatchTime,this),this.static&&(this.static.removeListeners(),this.static.stop())}}const ie=function(e,t,i,s){if(0!==s.indexOf(e))return!1;const a=parseFloat(s.slice(e.length));return!(a<t||a>i)&&a},se=ie.bind(null,"800000",10,90),ae=ie.bind(null,"900000",10,90),re=ie.bind(null,"JWIAB",1,999),ne=ie.bind(null,"120321",10,90),le=ie.bind(null,"120241",10,90),oe=ie.bind(null,"15010",1,698),de=["15020012","15020023","15020034"],he=/^[^:/?#]+:?\/\/[^/?#]+/,ce=function(e,t){if(!e)return;if(!t)return e;let i,s="",a="";Object.keys(t).forEach((e=>{const i=t[e];s=`${s}${a}${e}=${i}`,a="&"}));const r=(e=>{if(e)return new URL(e,window.location)})(e),n=r.pathname;return r.searchParams.has("cust_params")?r.searchParams.set("cust_params",`${s}&${r.searchParams.getAll("cust_params")}`):r.searchParams.set("cust_params",s),i=r.toString(),0===e.indexOf("./")?i=`.${i.substring(i.indexOf(n))}`:0===e.indexOf("../")?i=`..${i.substring(i.indexOf(n))}`:0!==e.indexOf(`${r.protocol}`)||e.includes("://")?0===e.indexOf("//")?i=i.replace(r.protocol,""):0!==e.indexOf("//")&&0===e.indexOf("/")?i=i.substring(i.indexOf(n)):0!==e.indexOf("/")&&0===e.indexOf(r.pathname.substring(1))&&(i=i.substring(i.indexOf(n)+1)):i=i.replace("://",":"),i},pe=e=>e?new URL(e).hostname:"",ue=(e,t=document.location.search)=>{if(e)return new URLSearchParams(t).getAll(e)},me=/^(https?:\/\/).*.(?:ampproject.org|bing-amp.com)\/(?:.\/)*(.*)\/amp.*$/,ge=function(){if(!((e,t)=>{if(e)return new URLSearchParams(e).has(t)})(document.location.search,"isAMP"))return;const e=ue("consentValue").join(),t=ue("consentGdpr").join();return e||t?{gdprApplies:t,consentData:e}:void 0},ye=Date.now||function(){return(new Date).getTime()},fe=e=>{const t=(e=>{let t=window;for(;t;){try{if(t.frames[e])break}catch(e){}t=t===window.top?null:t.parent}return t})(`${e}Locator`);return null!==t&&function(i,s,a,r){const n=ye(),l=t=>{let i=t?t.data:{};if("string"==typeof i)try{i=JSON.parse(i)}catch(e){i={}}const s=`${e}Return`;i[s]&&i[s].callId===n&&(removeEventListener("message",l),a(i[s].returnValue,i[s].success))};window.addEventListener("message",l,!1);const o=void 0!==r?"version":"parameter",d={[[`${e}Call`]]:{command:i,callId:n,parameter:r,[[o]]:s}};t.postMessage(JSON.stringify(d),"*")}};let ve=null,Pe={gdprApplies:!0,consentData:""};const Ae=function(e=1e3){return null===ve&&(ve=new Promise((e=>{const t=window.__tcfapi||fe("__tcfapi");if(t)return t("getTCData",2,((t,i)=>{e(!1!==i?{gdprApplies:t.gdprApplies,consentData:t.tcString,addtlConsent:t.addtlConsent}:null)}));const i=window.__cmp||fe("__cmp");if(i)return i("getConsentData",null,((t,i)=>{e(!1!==i?{gdprApplies:t.gdprApplies||t.isUserInEu,consentData:t.consentData}:null)}));const s=ge();return e(s||{gdprApplies:!1,consentData:""})})).then((e=>(e&&(Pe=e),Pe)))),Promise.race([ve,new Promise((t=>{setTimeout(t,e,Pe)}))])},ke=function(e){const t=e.advertising;if(null!=t&&t.placement){const e=t.placement.toLowerCase();if(w[e])return w[e]}return w[null!=t&&t.outstream?k:A]},we=function(){const e=(t=document.referrer)&&null!==t.match(he)?function(e){const t=e.match(me);return t&&t.length>1?`${t[1]}${t[2]}`:e}(document.referrer):"";var t;if(window.top!==window.self){try{return{url:window.top.location.href,domain:window.top.document.domain,referrer:e}}catch(e){}return{url:e,domain:pe(e),referrer:""}}return{url:document.location.href,domain:document.domain,referrer:e}},be=function(e,t){const i=e.getPlugin("inference"),s=t.jwpseg_client_side,a=t.jwpseg||[];let r;if(!s||!s.length||!i)return a;try{r=i.predict(s,t)}catch(e){return t.jwpseg||[]}return[...Object.keys(r).filter((e=>r[e])),...a.filter((e=>-1===s.indexOf(e)))]},Ee=function(e){const t=[],i=[],s=[],a=[];let r=Boolean(e.some((e=>/^1/.test(String(e)))));for(let a of e){"string"!=typeof a&&(a=String(a));const e=se(a);if(e){t.push(e);continue}const n=ne(a);if(n){t.push(n);continue}const l=ae(a);if(l){i.push(l);continue}const o=le(a);if(o){i.push(o);continue}const d=re(a);if(d){s.push(d);continue}const h=oe(a);h?s.push(h):de.includes(String(a))?r=!1:"JWBRSAFE"!==a||(r=!0)}if(r&&a.push(1),t.length||i.length||s.length||a.length){const e={hb_jwvb:t,hb_jwcr:i,hb_jwiab:s,hb_jwbs:a};return Object.keys(e).forEach((t=>{e[t]=[...new Set(e[t])]})),e}return null},Ie=(e,t=!1)=>{const i=t?0===e.getPosition()&&"idle"===e.getState():0===e.getPosition();return e.isBeforePlay()||i?"pre":e.isBeforeComplete()||e.getPosition()===e.getDuration()?"post":"mid"},_e=(t,i=null,s={})=>{const a={client:e};if(null===t)return a;const{bidding:r,config:n,item:l,player:o}=t;t.isDestroyed()||(a.placement=ke(o.getConfig()));const d=s.schedule;if(d)return Object.assign(a,{item:l,tag:d.getVMAP(),adbreaks:d.getAllAds().map((e=>{const t={type:e._type,offset:e._offSet};if(e._vmap?t.vmap=e._vmap:t.adbreak=Object.assign({},e._adbreak),r){const i=r.getBid(e.adPlayId);i&&Object.assign(t,i.getEventObject())}return t}))});if(n.preloadAds&&(a.preloadAds=s.preload||(null==i?void 0:i._preload)||!1),s.jwpseg&&(a.jwpseg=s.jwpseg),i){const{adBreakId:e,adPlayId:n}=t.getAdIds(i,s);if(Object.assign(a,{adBreakId:e,adPlayId:n,offset:i._offSet}),r){const e=r.getBid(n);e&&Object.assign(a,e.getEventObject())}}const h=i&&(s.tag||i._currentTag);if(h&&(Object.assign(a,{id:i._id,tag:h,adposition:i._position,sequence:i._adPodIndex+1,witem:i._waterfallIndex+1,wcount:i._adQueue?i._adQueue.length:1,adsystem:i.adsystem||""}),i.adServingId&&(a.adServingId=i.adServingId),void 0!==i.skipoffset&&(a.skipoffset=i.skipoffset),i.wrappedTags&&Object.assign(a,{wrapperAdSystem:i.wrapper||"",wrappedTags:i.wrappedTags.slice(1),wrapperAdIds:i.adIds}),i._adbreak&&(a.adschedule=i._adbreak,a.adschedule.offset=i._offSet)),null!=i&&i.companions&&s.companions)return a.companions=s.companions,a;if(null!=i&&i.response){const{params:e}=t;Object.assign(a,{adtitle:i.adTitle||"",description:i.description||"",adId:i.adId||"",adVerifications:i.adVerifications||null,advertiser:i.advertiser||"",advertiserId:i.advertiserId||"",creativeId:i.creativeId||"",creativeAdId:i.creativeAdId||"",dealId:i.dealId||"",conditionalAd:i.conditionalAd,conditionalAdOptOut:e.conditionaladoptout,vastversion:i.vastversion,clickThroughUrl:i.clickthrough,duration:s.duration,linear:s.linear});const r=o.getEnvironment();r.Features.headless&&r.OS.iOS||Object.assign(a,{request:i.request,response:i.response}),"boolean"==typeof i.mediaFileCompliance&&(a.mediaFileCompliance=i.mediaFileCompliance,i.nonComplianceReasons&&(a.nonComplianceReasons=i.nonComplianceReasons)),i.selectedMedia&&(a.mediafile={file:i.selectedMedia.file}),s.metadata&&(a.adMessage=e.dynamicMessage||"",i.companions&&(a.companions=i.companions),i.sequence&&(a.podMessage=e.podMessage||""),void 0!==i.skipoffset&&Object.assign(a,{skipmessage:e.skipmessage,skiptext:e.skiptext}))}else a.item=l;return a},Te=(e,t,i,s)=>{const a=_e(e,i,s),r=t.adErrorCode||60900;return Object.assign(a,{message:t.message,code:t.code>=100&&t.code<=1008?t.code:900,adErrorCode:r}),10402===r||50004===r||50400===r?a.timeout=i?i.creativeTimeout:s.creativeTimeout:11007!==r&&10301!==r&&60006!==r||(a.timeout=i?i.requestTimeout:s.requestTimeout),void 0!==t.id&&(a.id=t.id),void 0!==t.sourceError&&(a.sourceError=t.sourceError),void 0!==t.tag&&(a.tag=t.tag),void 0!==t.vmap&&(a.vmap=t.vmap),a},Ce=function(e,t=null,i={}){const s={client:e.client},{bidding:a,item:r,player:n}=e;if(e.isDestroyed()||Object.assign(s,{placement:ke(n.getConfig()),viewable:n.getViewable()}),i.jwpseg&&(s.jwpseg=i.jwpseg),t){const{adBreakId:r,adPlayId:n}=e.getAdIds(t,i);if(Object.assign(s,{adBreakId:r,adPlayId:n,offset:t._offSet}),a){const e=a.getBid(n);e&&Object.assign(s,e.getEventObject())}}return s.item=r,s},xe=function(e,t,i,s){return{client:s,message:e,adErrorCode:t,id:x,placement:ke(i),tag:""}};var Se=function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Object.prototype.hasOwnProperty.call(Object(e),t)};const Re=/^((https?:)?\/\/)?(secure)?pubads\.g\.doubleclick\.net\/gampad\/ads\?[\S]*$/,je=function(e,t,i){return e.replace(t,i)},Oe=function(e,t){const i=Math.pow(10,t);return Math.round(e*i)/i},Me=function(s,a,r,n,l,o={}){var d,h,c,p,u,m,g;if(!s)return s;const y=function(e,t){const i=e.getConfig(),s=e.getPlaylistItem()===t,a={playerHeight:e.getHeight()||i.height||"",playerWidth:e.getWidth()||i.width||"",itemDuration:s&&Oe(e.getDuration(),3)||"",integerDuration:s&&Oe(t.duration,0)||"",item:t,jwpseg:be(e,t),placement:ke(i),userAgent:navigator.userAgent},r=i.advertising?i.advertising.ampMacros:{};return Object.assign(a,r)}(a,r),f=we();let v=null;null!=r&&r.jwpseg&&(v=Ee(r.jwpseg));const A={viewability:(null==(d=v)||null==(h=d.hb_jwvb)?void 0:h.map((e=>encodeURIComponent(e))).join(","))||"",completion:(null==(c=v)||null==(p=c.hb_jwcr)?void 0:p.map((e=>encodeURIComponent(e))).join(","))||"",brandSafety:1===(null==(u=v)?void 0:u.hb_jwbs[0])?encodeURIComponent("Yes"):encodeURIComponent("No"),contextual:(null==(m=v)||null==(g=m.hb_jwiab)?void 0:g.map((e=>encodeURIComponent(e))).join(","))||""};-1!==s.indexOf(P)&&(o.jwpseg=y.jwpseg),s=je(s,"__random-number__",Math.random()*Math.pow(10,18)),s=je(s,"__timestamp__",(new Date).getTime()),s=je(s,"__page-url__",encodeURIComponent(y.pageUrl||f.url)),s=je(s,"__referrer__",encodeURIComponent(y.referrer||f.referrer)),s=je(s,"__player-height__",y.playerHeight),s=je(s,"__player-width__",y.playerWidth),s=je(s,"__item-duration__",y.itemDuration),s=je(s,"__integer-duration__",y.integerDuration),s=je(s,P,y.jwpseg),s=je(s,"__domain__",encodeURIComponent(y.domain||f.domain)),s=je(s,"__placement__",y.placement),s=je(s,"__device-ua__",encodeURIComponent(y.userAgent)),s=je(s,"__jw-viewability__",A.viewability),s=je(s,"__jw-completion__",A.completion),s=je(s,"__jw-brand-safety__",A.brandSafety),s=je(s,"__jw-contextual__",A.contextual),s=l.companion?je(s,"__companion-div__",l.companion.id):je(s,"__companion-div__","");const k=Object.keys(y).filter((e=>-1!==e.indexOf("item"))),w=k.map((e=>{const t=e.match(/item([\w]+?)(List)?$/);let i;return t&&(i=t[1].toLowerCase()),i}));let b=null;const E=/__item-([\w-]+?)(-list)?__/g,I=s;for(;null!==(b=E.exec(I));){const e=b[0],t=b[1],i=k[w.indexOf(t)];let a="";if(Se(r,t)&&"string"==typeof r[t]||i){a=i?y[i]:r[t];const e=!1===l.truncateMacros?4096:1e3;a.length>e&&(a=a.substring(0,e));const s=b[2]?",":null;a=a.split(s).map(encodeURIComponent)}s=je(s,e,a)}if(n===i)return s;if(n===e){const e=a.getConfig().autostart?1:0,t=a.getMute()?1:0;s=function(e,t,i){return Re.test(e)&&(e=`${e}&vpa=${t}&vpmute=${i}`),e}(s,e,t)}if((n===t||"cnx"===n)&&r.title&&-1===s.indexOf("vid_t=")){const e=r.title.substring(0,100).replace(/[^\x00-\x7F]/g,"");s+=`${function(e){return-1!==e.indexOf("?")?"&":"?"}(s)}vid_t=${encodeURIComponent(e)}`}return-1!==s.indexOf("__gdpr__")||-1!==s.indexOf("__gdpr_consent__")||-1!==s.indexOf("__addtl_consent__")?Ae().then((({gdprApplies:e,consentData:t,addtlConsent:i})=>(s=je(s,"__gdpr__",e?1:0),s=je(s,"__addtl_consent__",i||""),je(s,"__gdpr_consent__",t||"")))).catch((()=>s)):Promise.resolve(s)},{forEach:Be,map:Ve}=Array.prototype,Le=function(){},He=function(e,t,i){let s=[];return e&&(s=e.getElementsByTagName(t),i&&s&&0===s.length&&(s=e.getElementsByTagName(`${i}:${t}`))),s},Fe=function(e,t){return e?e.getAttribute(t):null},De=function(e,t,i){e.push({message:t,code:1002,adErrorCode:70001,id:i})},Ne=function(){const e=new Error("No AdBreaks in VMAP");throw e.adErrorCode=60005,e},qe=function(e){if(e){const t=e.textContent||e.text;if(t)return t.trim()}return""},Ue=function(e,t,i,s){let a=[];return e||t?(a=t.getElementsByTagNameNS?t.getElementsByTagNameNS(e,i):t.getElementsByTagName(`${s}:${i}`),a):a},Qe=function(e,t){if(e){const i=e.getElementsByTagName(t);if(i)return i[0]}return null};let $e=function(e){(e.indexOf(g)>=0||e.indexOf(m)>=0)&&(Ae().catch(Le),$e=Le)};const Xe=function(e,t,i){e[t]||(e[t]=[]),i&&(e[t].push(i),$e(i))},We=function(e,t){let i=Fe(t,"event");if("progress"===i){i=`${i}_${Fe(t,"offset")}`}const s=qe(t);Xe(e,i,s)},ze=function(e,t){if(!e)return null;const i=e.getElementsByTagName("Ad");if(!i.length)return null;const s={_offSet:t};if(1===i.length)s._adQueue=[i[0].textContent.trim()];else{s._pod=[];for(let e=0;e<i.length;e++)s._pod.push(i[e].textContent.trim())}return s},Je=function(e,t,i){if(He(e,"VMAP",S).length)return function(e,t,i){const s=[],a=He(e,"VMAP",S);Fe(a[0],"version")||De(s,"VMAP Schema Error: version missing from VMAP tag",x);const r=He(e,"AdBreak",S);r.length||Ne();const n=e.lookupNamespaceURI(S),l={};for(let e=0;e<r.length;e++){const t={},i={},a=r[e],d=Fe(a,"timeOffset")||0,h=Fe(a,"breakId"),c=Fe(a,"breakType"),p=He(a,"AdSource",S)[0],u=Fe(p,"id"),m=He(a,"AdTagURI",S)[0],g=He(a,"VASTData",S)[0]||He(a,"VASTAdData",S)[0],y=Fe(m,"templateType"),f=qe(m),v=Ue(n,a,"Tracking",S);if(c||De(s,"VMAP Schema Error: missing breakType on AdBreak",h),g||y||De(s,"VMAP Schema Error: missing templateType on AdBreak",h),d||De(s,"VMAP Schema Error: missing timeOffset on AdBreak",h),t._type=c,t._vmap={id:u,breakid:h,timeoffset:d},g)t._adXML=(o=Qe(g,"VAST")).ownerDocument instanceof Document?o.outerHTML||(new XMLSerializer).serializeToString(o):null;else{if("vast2"!==y&&"vast3"!==y&&"vast4"!==y)continue;t._adQueue=[f],t._waterfallIndex=0}const P=[];if(v)for(let e=0;e<v.length;e++){We(i,v[e]);const t=Fe(v[e],"event");P.push(t)}(P.indexOf("breakStart")<0||P.indexOf("breakEnd")<0||P.indexOf("error")<0)&&De(s,"Tracking events are missing breakStart, breakEnd, or error for AdBreak",h),t._trackers=i,t._type=c;const A="number"==typeof d||"string"==typeof d;A&&!l[d]?(l[d]=t,l[d]._pod=t._adQueue?[...t._adQueue]:[]):A&&l[d]&&t._adQueue&&l[d]._pod.push(...t._adQueue)}var o;return Object.keys(l).forEach((e=>{const s=l[e];switch(s._pod&&s._pod.length<=1&&delete s._pod,e){case"start":s._offSet="pre",t.setPreRoll(s);break;case"100%":case"end":s._offSet="post",t.setPostRoll(s);break;default:if(/^#/.test(e))break;/^\d\d?(?:\.\d+)?%$/.test(e)?s._offSet=e:s._offSet=i.seconds(e),t.addMidRoll(s)}})),t.preRoll||t.midRolls.length||t.postRoll||Ne(),t.sort(null,!0),s}(e,t,i);if(He(e,"Playlist",S).length)return function(e,t,i){const s=He(e,"Playlist",S)[0],a=s.getElementsByTagName("Preroll")[0],r=s.getElementsByTagName("Postroll")[0],n=ze(a,"pre"),l=ze(r,"post");n&&t.setPreRoll(n),l&&t.setPostRoll(l);const o=s.getElementsByTagName("Midroll");for(let e=0;e<o.length;e++){const s=o[e],a=i.seconds(s.getAttribute("timeOffset")),r=ze(s,a);t.addMidRoll(r)}return[]}(e,t,i);throw new Error("No VMAP tag in response")},Ge=function(e,t,i){const s=He(e,t);Ve.call(s,(e=>{Xe(i,t.toLowerCase(),qe(e))}))},Ye=function(e,t,i){const s=He(Qe(e,"Creatives"),"Creative"),a={},r={trackers:a};r.adServingId=qe(Qe(e,"AdServingId")),r.adsystem=qe(Qe(e,"AdSystem"));const n=He(e,"Category");return r.categories=Ve.call(n,(e=>qe(e))),Be.call(s,(e=>{const s=Qe(e,"Linear"),n=Qe(e,"NonLinear"),l=He(Qe(e,"TrackingEvents"),"Tracking");if(t>=4){const t=He(e,"UniversalAdId");r.universalAdId=Ve.call(t,(e=>({universalAdIdRegistry:Fe(e,"idRegistry")||"unknown",universalAdIdValue:qe(e)||Fe(e,"idValue")||"unknown"})))}r.creativeId=Fe(e,"id"),r.creativeAdId=Fe(e,"adId"),s&&(r.linear=!0),(s||n)&&Be.call(l,(e=>{We(a,e)}));const o=qe(Qe(e,"AdParameters"));if(o&&(r.adParams=o),s){const e=Qe(s,"VideoClicks"),t=qe(Qe(e,"ClickThrough")),n=He(e,"ClickTracking"),l=Fe(s,"skipoffset"),o=qe(Qe(s,"Duration"));Be.call(n,(e=>{Xe(a,"click",qe(e))})),o&&(r.duration=i.seconds(o)),t&&(r.clickthrough=t),void 0!==l&&(r.skipoffset=l),function(e,t){const i=He(Qe(e,"MediaFiles"),"MediaFile"),s=t.media?t.media:[];t.media=s.concat(Ve.call(i,(e=>({type:Fe(e,"type"),file:qe(e),adType:Fe(e,"apiFramework")||"",width:parseInt(Fe(e,"width"),10)||0,height:parseInt(Fe(e,"height"),10)||0,bitrate:parseInt(Fe(e,"bitrate"),10)||null,maxBitrate:parseInt(Fe(e,"maxBitrate"),10)||null}))).filter((e=>e.file)))}(s,r),function(e,t){const i=He(e,"Icon");t.icons=Array.prototype.reduce.call(i,((e,t)=>{let i,s;if(i=Qe(t,"StaticResource"))s=Fe(i,"creativeType");else if(i=Qe(t,"IFrameResource"))s="iframe";else{if(!(i=Qe(t,"HTMLResource")))return e;s="html"}const a=qe(i),r={};r.iconClick=qe(Qe(t,"IconClickTracking"))||null,r.iconView=qe(Qe(t,"IconViewTracking"))||null;const n=Fe(t,"xPosition").toLowerCase(),l=Fe(t,"yPosition").toLowerCase(),o={};return"left"===n||"right"===n?o[n]=0:o.left=parseInt(n,10)||0,"top"===l||"bottom"===l?o[l]=0:o.top=parseInt(l,10)||0,o.width=parseInt(Fe(t,"width"),10)||0,o.height=parseInt(Fe(t,"height"),10)||0,e.push({program:Fe(t,"program"),style:o,apiFramework:Fe(t,"apiFramework"),offset:Fe(t,"offset")||"00:00:00",duration:Fe(t,"duration")||null,clickThrough:qe(Qe(t,"IconClickThrough")),trackers:r,resource:{resourceType:s,resourceSource:a}}),e}),t.icons||[])}(s,r)}else if(n){const t=qe(Qe(n,"NonLinearClickThrough")),i=He(n,"NonLinearClickTracking");Be.call(i,(e=>{Xe(a,"click",qe(e))})),t&&(r.clickthrough=t),function(e,t){const i=[],s=Qe(e,"StaticResource");s&&!t.media&&(i.push({type:Fe(s,"creativeType"),file:qe(s),adType:Fe(Qe(e,"NonLinear"),"apiFramework")||"static",minDuration:Fe(Qe(e,"NonLinear"),"minSuggestedDuration")||"00:00:00"}),t.media=i)}(e,r)}else!function(e,t){const i=He(Qe(e,"CompanionAds"),"Companion"),s=t.companions?t.companions:[];Be.call(i,(e=>{const t=Qe(e,"StaticResource"),i=Qe(e,"IFrameResource"),a=Qe(e,"HTMLResource"),r={};let n,l;if(t)n=Fe(t,"creativeType"),l=qe(t);else if(i)n="iframe",l=qe(i);else{if(!a)return;n="html",l=qe(a)}const o=He(Qe(e,"TrackingEvents"),"Tracking");Be.call(o,(e=>{const t=Fe(e,"event");Xe(r,t,qe(e))}));const d=qe(Qe(e,"CompanionClickThrough"));s.push({width:parseInt(Fe(e,"width"),10),height:parseInt(Fe(e,"height"),10),type:n,source:l,trackers:r,clickthrough:d})})),t.companions=s}(e,r)})),r};class Ke{constructor(e,t){this.utils=t,this._error=null,this._version=null,e&&this.parse(e)}error(){return this._error}version(){return this._version}parse(e,t){let i;"VAST"===e.nodeName?i=e:(i=Qe(e,"VAST"),i||(i=Qe(e,"VideoAdServingTemplate"))),i||this.throwError(101,"Invalid VAST response");const s="VideoAdServingTemplate"===i.tagName?1:parseFloat(Fe(i,"version")||0);this._version=s;const a=He(i,"Ad"),r=Ve.call(a,(i=>{const a=this.parseAd(s,i);return a.vastversion=s,a.response=e,a.request=t||null,a}));return r.length||function(e){const t=He(e,"Error");Be.call(t,(e=>{const t=qe(e).replace(u,303);(new Image).src=t}))}(i),r.extensionNodes=this.parseExtensions(e),r}parseAd(e,t,i){i=i||{};const s=Qe(t,"InLine"),a=Qe(t,"Wrapper"),r=s||a;let n;const l=Qe(r,"Advertiser"),o=Qe(r,"AdVerifications");return o&&(i.adVerifications=function(e){const t=He(e,"Verification"),i=[];return Be.call(t,(e=>{const t=Fe(e,"vendor"),s=Qe(e,"JavaScriptResource"),a=Qe(e,"ExecutableResource"),r=qe(Qe(e,"VerificationParameters")),n=He(Qe(e,"TrackingEvents"),"Tracking"),l={},o={vendor:t,verificationParameters:r,trackers:l};s&&(o.javaScriptResource={url:qe(s),apiFramework:Fe(s,"apiFramework"),browserOptional:Fe(s,"browserOptional")}),a&&(o.executableResource={url:qe(a),apiFramework:Fe(a,"apiFramework"),type:Fe(a,"type")}),Be.call(n,(e=>{We(l,e)})),i.push(o)})),i}(o)),i.sequence=Fe(t,"sequence"),i.adId=Fe(t,"id"),i.adTitle=qe(Qe(r,"AdTitle")),i.advertiser=qe(l),i.advertiserId=Fe(l,"id"),i.description=qe(Qe(r,"Description")),i.dealId=qe(Qe(r,"DealId")),(!e||e>4.2||e<2)&&this.throwError(102,"Vast version not supported"),e>=4&&(i.conditionalAd=Boolean(Fe(t,"conditionalAd"))),r?(n=Ye(r,e,this.utils),Ge(r,"Impression",n.trackers),Ge(r,"Error",n.trackers),Ge(r,"NotViewable",n.trackers),Ge(r,"Viewable",n.trackers),function(e){const t={};e.media&&e.media.forEach((e=>{const i=e.type,s="application/x-mpegURL"===i||"vnd.apple.mpegURL"===i;"vpaid"===e.adType.toLowerCase()||s||(t[i]=t[i]||0,t[i]++)})),e.mediaFileCompliance=!0,Object.keys(t).forEach((i=>{const s=t[i];s<3&&(e.mediaFileCompliance=!1,e.nonComplianceReasons=e.nonComplianceReasons||[],e.nonComplianceReasons.push(`${i} has only ${s} qualities`))}))}(n),a&&(n.wrappedURI=qe(Qe(a,"VASTAdTagURI"))||qe(Qe(a,"VASTAdTagURL")),n.followAdditionalWrappers=JSON.parse(Fe(a,"followAdditionalWrappers")),n.allowMultipleAds=JSON.parse(Fe(a,"allowMultipleAds")),n.fallbackOnNoAd=JSON.parse(Fe(a,"fallbackOnNoAd"))),n=function(e,t){const i=Object.assign({},e);return Object.keys(t).forEach((e=>{const s=t[e];Array.isArray(i[e])?i[e]=i[e].concat(s):"object"==typeof i[e]&&null!==i[e]?i[e]=Object.assign(i[e],s):i[e]=s})),i}(i,n)):this.throwError(303,"No ads",10303),n}parseExtensions(e){const t={},i=Qe(e,"Extensions");if(!i||!i.childNodes||!i.childNodes.length)return null;for(let e=0;e<i.childNodes.length;e++){const s=i.childNodes[e];if("Extension"===s.nodeName){const a=Fe(s,"type");t[a]=t[a]?t[a].concat(i.childNodes[e]):[i.childNodes[e]]}}return t}throwError(e,t,i){throw this._error=new Error(t),this._error.code=e,this._error.adErrorCode=i||1e4+e,this._error}}const Ze=function(e){e.onload=e.onreadystatechange=e.onerror=null,"abort"in e&&e.abort()},et=function(e,t,i){if(null===e)return;let s;return Object.keys(e).forEach((t=>{const i=e[t];s=s||{},s[t]="_adQueue"===t||"_pod"===t?i.slice():i})),s?(s.requestTimeout=t,s.creativeTimeout=i,s._errors=[],s._waterfallIndex=0,s._adPodIndex=0,s):void 0},tt=function(e,t){return"%"===e.toString().slice(-1)?t*parseFloat(e.slice(0,-1))/100:parseFloat(e)};class it{constructor(e,t){this.adRules=e,this.utils=t,this.logger=this.utils.logger.child("ads-shared/Schedule"),this.preRoll=null,this.vmap=null,this.postRoll=null,this.midRolls=[],this.playedMidRolls=[],this.duration=0,this._vmapPromise=null,this._vmapXHR=null}load(e,i,s,a){if(this._vmapPromise)return this._vmapPromise;null!==this._vmapXHR&&(Ze(this._vmapXHR),this._vmapXHR=null);const r=Me(this.getVMAP(),e,i,s,a);return s===t?(this._vmapPromise=r.then((e=>{this.setPreRoll({_adQueue:[e]})})),this._vmapPromise):(this._vmapPromise=r.then((t=>new Promise(((i,s)=>{this._vmapXHR=e.utils.ajax({url:t,withCredentials:a.withCredentials,retryWithoutCredentials:!0,requireValidXML:!0,timeout:this.requestTimeout},i,((e,t,i,a)=>s(a)))})).then((i=>{this._vmapXHR=null,e.trigger(E,{client:s,tag:t,xml:i.responseXML});return Je(i.responseXML,this,e.utils).map((e=>Object.assign(e,{vmap:t})))})).catch((i=>{this._vmapXHR=null;const s={id:x,vmap:t};if(i.message)Object.assign(s,{message:`VMAP Schema Error: ${i.message}`,code:1002,adErrorCode:i.adErrorCode||11002});else{const t={1:{code:1007,message:"Timeout"},602:{code:1e3,message:"Invalid XML"},default:{code:1008,message:e.getConfig().localization.errors[i.key]}},a=t[i.code]||t.default;this.logger.error(a.message),Object.assign(s,{message:"Error Loading VMAP Schedule",code:a.code,adErrorCode:a.code+1e4})}throw s})))),this._vmapPromise)}canWaterfall(e){return e._adQueue&&e._waterfallIndex+1<e._adQueue.length}getPreRoll(e){return e&&"none"===this.adRules.startOnSeek?null:et(this.preRoll,this.requestTimeout,this.creativeTimeout)}getPostRoll(e){const t=et(this.postRoll,this.requestTimeout,this.creativeTimeout);return this.adRules.timeBetweenAdsAllowsAdPlayback(t,e)?t:null}getMidRollAtIndex(e){const t=this.midRolls[e];return et(t,this.requestTimeout,this.creativeTimeout)}getLastMidRollIndexBetweenTime(e,t,i){if(e>t)return null;this.sort(i);let s=this.midRolls.length;for(;s--;){const a=this.midRolls[s],r=tt(this.midRolls[s]._offSet,i);if(e>=r)return null;if(t>=r){const e=et(a,this.requestTimeout,this.creativeTimeout);if(!this.adRules.timeBetweenAdsAllowsAdPlayback(e))return null;if(!this.adRules.timeBetweenAds){if(this.playedMidRolls.indexOf(s)>=0)return null;this.playedMidRolls.push(s)}return s}}return null}peek(e,t,i){if(this.midRolls.length>this.playedMidRolls.length){this.sort(i);let s=0;for(;this.midRolls[s];){const a=this.midRolls[s],r=tt(a._offSet,i);if(r>=e&&-1===this.playedMidRolls.indexOf(s)){const i=ye()+1e3*(r-e);return r<=t&&this.adRules.timeBetweenAdsAllowsAdPlayback(null,i)?s:null}s+=1}}const s=ye()+1e3*(i-e);return this.postRoll&&t>=i&&this.adRules.timeBetweenAdsAllowsAdPlayback(null,s)?-1:null}getNextMidrollIndex(e,t,i){if(this.adRules.timeBetweenAds||this.adRules.startOnSeek)return this.getLastMidRollIndexBetweenTime(e,t,i);if(this.midRolls.length>this.playedMidRolls.length){const e=this.getClosestIndex(t,i);if(e>=0&&this.playedMidRolls.indexOf(e)<0)return this.playedMidRolls.push(e),e}return null}getMidRolls(){return this.midRolls.map((e=>et(e,this.requestTimeout,this.creativeTimeout)))}reset(){null!==this._vmapXHR&&(Ze(this._vmapXHR),this._vmapXHR=null),this.playedMidRolls=[],this.duration=0}setPreRoll(e){e&&this.resetBreakId(e),this.preRoll=e}addMidRoll(e){this.resetBreakId(e),this.midRolls.push(e),this.duration=0}setPostRoll(e){e&&this.resetBreakId(e),this.postRoll=e}sort(e,t){(!e||e<1)&&(e=1),(this.duration!==e||t)&&(this.duration=e,this.midRolls.forEach((t=>{t._offsetSeconds=tt(t._offSet,e)})),this.midRolls.sort(((e,t)=>e._offsetSeconds-t._offsetSeconds)),function(e,t){for(let i=0;i<e.length;i++){const s=e[i];t?s._vmap.item=i+1:(s._adbreak={item:i+1,breakid:s._breakId},s._pod?s._adbreak.pod=s._pod:s._adbreak.tags=s._adQueue)}}(this.getAllAds(),t))}getAllAds(){const e=this.preRoll?[this.preRoll]:[],t=this.postRoll?[this.postRoll]:[];return e.concat(this.midRolls,t)}setVMAP(e){this.vmap=e}isVMAP(){return Boolean(this.vmap)}getVMAP(){return this.vmap}getClosestIndex(e,t){this.sort(t);let i=this.midRolls.length;for(;i--;)if(e>=tt(this.midRolls[i]._offSet,t))return i;return-1}clearAds(){this.preRoll=null,this.midRolls.length=0,this.postRoll=null}resetBreakId(e){e.adBreakId=this.utils.genId(12)}resetAllBreakIds(){this.getAllAds().forEach((e=>{this.resetBreakId(e)}))}destroy(){this.reset(),this.adRules.destroy()}}const st=function(e){return Array.isArray(e)?e.slice(0):[e]},at=function(e,t){return 0===e?1/0:e||t},rt=function(e,t,i){const s=t.schedule||t.adschedule;if(!s)return;const a=i.logger.child("ads-shared/ConfigParser"),r={};Object.keys(s).forEach((e=>{const t=s[e];t.ad&&(Object.assign(t,t.ad),delete t.ad);const n=function(e,t,i=!0){if("start"===e||"0%"===e||i&&!e&&0!==e)return"pre";if("end"===e||"100%"===e)return"post";if("string"==typeof e&&("pre"===e||"post"===e||e.indexOf("%")>=0))return e;const s=t.seconds(e);return"number"==typeof s&&!isNaN(s)&&s}(t.offset,i),l=at(t.requestTimeout,f),o=at(t.creativeTimeout,5e3);let d=r[n];if(d){if("nonlinear"===t.type)return;"nonlinear"===d._type&&(d=null)}const h=r[n]=d||{_offSet:n,_type:t.type,_breakId:e,adBreakId:i.genId(12),requestTimeout:l,creativeTimeout:o};!1===n&&a.error("Error: ad offset format not supported",n);const c=t.skipoffset;if(void 0!==c&&void 0===h.skipoffset&&(h.skipoffset=c),"string"==typeof t.adm)h.adm=t.adm;else if(t.pod){const e=h._pod||[];h._pod=e.concat(t.pod)}else if(t.tag){const e=ce(t.tag,t.custParams);h._adQueue&&(h._pod=[h._adQueue[0]],delete h._adQueue),h._pod?h._pod.push(st(e)[0]):h._adQueue=st(e)}else"string"==typeof t.vastxml?h._adXML=t.vastxml:a.error("Error: no ad tag provided")})),Object.keys(r).forEach((i=>{const s=r[i];switch(s.skipoffset=void 0!==s.skipoffset?s.skipoffset:t.skipoffset,i){case"pre":e.setPreRoll(s);break;case"post":e.setPostRoll(s);break;default:e.addMidRoll(s)}}))};class nt{constructor(e){this.utils=e}getSchedule(e,t){const i=new it(t,this.utils);if(i.requestTimeout=at(e.requestTimeout,f),i.creativeTimeout=at(e.creativeTimeout,5e3),e.tag)i.setPreRoll({_offSet:"pre",_adQueue:st(e.tag),_waterfallIndex:0});else if("string"==typeof e.vastxml)i.setPreRoll({_offSet:"pre",_adXML:e.vastxml});else{if("string"==typeof e.schedule)return i.setVMAP(e.schedule),i;if("string"==typeof e.adschedule)return i.setVMAP(e.adschedule),i;rt(i,e,this.utils)}return i.sort(),i}getOptParams(e,t){const i={cuetext:t.cuetext,dynamicMessage:t.admessage,loadingAd:t.loadingAd,podMessage:t.podmessage,skipoffset:e.skipoffset,skipmessage:t.skipmessage,skiptext:t.skiptext,omidAccessMode:e.omidAccessMode||"full",omidSupport:e.omidSupport||"auto",allowedOmidVendors:e.allowedOmidVendors||[],vpaidcontrols:e.vpaidcontrols||!1,conditionaladoptout:e.conditionaladoptout||!1,requestFilter:e.requestFilter,trackingFilter:e.trackingFilter,withCredentials:void 0===e.withCredentials||e.withCredentials,extensions:"[object Object]"===Object.prototype.toString.call(e.extensions)?e.extensions:{}},s=e.companiondiv;return s&&(i.companion={id:s.id,height:s.height,width:s.width}),i}getAdRules(e){const t=e.rules||{},i=parseInt(t.frequency,10);return{startOn:t.startOn||1,frequency:isNaN(i)?1:i,timeBetweenAds:t.timeBetweenAds||0,startOnSeek:t.startOnSeek||null,deferAds:t.deferAds||null}}}class lt{constructor(e,t){this.player=e,this.options=t,this.client=t.client,this.ignoreStartOnSeek=!1,this.reset(),t.timeBetweenAds&&e.on({adBreakStart:this.handleAdBreakStart,adSkipped:this.handleAdSkipped,adComplete:this.handleAdComplete,adBreakEnd:this.handleAdBreakEnd,destroyPlugin:this.destroy},this)}get timeBetweenAds(){return this.options.timeBetweenAds}get startOnSeek(){return this.ignoreStartOnSeek?null:this.options.startOnSeek}shouldDeferAds(){return this.options.deferAds&&!this.player.getConfig().activeTab}clearStartOnSeek(){this.ignoreStartOnSeek=!0}sendAdBreakIgnored(e,t){e&&this.player.trigger(v,function(e,t){let i={};return e&&(i={id:e._breakId,tag:e._adQueue&&e._adQueue.length>0?e._adQueue[0]:e._adXML,offset:e._offSet}),Object.assign(i,{timeSinceLastAd:t,type:v})}(e,t,this.client))}rulesAllowAdPlayback(e){const t=this.options,i=0===t.frequency&&1===e,s=e>=t.startOn&&(e-t.startOn)%t.frequency==0;return i||s}handleAdBreakStart(){this.adSkipped=!1,this.adComplete=!1}handleAdComplete(){this.adComplete=!0}handleAdSkipped(){this.adSkipped=!0}handleAdBreakEnd(){!this.adSkipped&&this.adComplete&&(this.recentCompletedAdTime=ye(),this.player.trigger("previousAdCompleteTime",{time:this.recentCompletedAdTime}))}timeBetweenAdsAllowsAdPlayback(e,t=ye()){if(this.options.timeBetweenAds){const i=(t-this.recentCompletedAdTime)/1e3;if(i<this.options.timeBetweenAds)return this.sendAdBreakIgnored(e,i),!1}return!0}reset(){this.ignoreStartOnSeek=!1,this.recentCompletedAdTime=0}destroy(){this.player.off(null,null,this)}}class ot{constructor(e,t,i,s,a){Object.assign(this,e.Events),this.client="shared",this.player=e,this.item=i,this.config=s,this.casting=a;const r=e.utils,n=new nt(r);this.adRules=new lt(e,n.getAdRules(s)),"string"==typeof t?(this.schedule=new it(this.adRules,r),this.schedule.setPreRoll({tag:t})):(this.schedule=t,t.resetAllBreakIds()),this.logger=this.player.utils.logger.child("ads-shared/PlaylistItemManager"),this.vmapPromise=null,this.lastTimeEvent=null,this.prerollPromise=null,this.midrollPromise={},this.postrollPromise=null,this.next=null,this.nextPlaylistItemPromise=null,this.relatedNextUp=null,this.bidding=e.getPlugin("bidding"),this.bids=[],this.bidsPromises=[],this.bidsPromise=null,this._events=[]}attachListeners(){this.player.on({all:this.onAll,beforePlay:this.checkPreroll,relatedReady:this.relatedReady,cast:this.onCast,destroyBidding:this.destroyBids},this)}onAll(e,t){this.isDestroyed()||(e===y?this.checkMidrolls(t):"beforeComplete"===e?this.checkPostrolls(t):"meta"===e&&this.schedule.sort(this.player.getDuration()),"complete"===e&&(this.player.videoHasCompleted=!0))}relatedReady(){if(this.config.preloadAds){const e=this.player.getPlugin("related");e&&e.on("nextUp",(e=>{e&&"discovery"===e.mode&&(this.relatedNextUp=e)}))}}onCast(e){this.casting=Boolean(e.active)}init(e,t){if(this.config.clearAdsOnComplete&&this.player.videoHasCompleted&&this.schedule.clearAds(),e=e||null,this.schedule.isVMAP()&&(t.requestTimeout=this.schedule.requestTimeout,t.creativeTimeout=this.schedule.creativeTimeout,this.vmapPromise=this.schedule.load(this.player,this.item,this.client,t)),this.bidsPromise=this.vmapPromise||Promise.resolve(),this.bidsPromise=null!==e?this.bidsPromise.then((()=>{if(this.isDestroyed())return;if(this.bidding)return this.createBidsPromise(e,t);const i=function(e,t,i){const s=Ce(e,t,i);return Object.assign(s,{message:"Ad Error: bidding plugin unavailable",code:900,adErrorCode:60008}),s}(this,null,t);this.player.trigger(b,i)})).catch((e=>this.logger.debug(e))):this.bidsPromise.catch((e=>this.logger.debug(e))),this.config.preloadAds)if(1===t.playlistItemEventCount){const e=this.player.getConfig().autostart;!1===e||"viewable"===e&&0===this.player.getViewable()?this.loadPreroll(t).catch((e=>this.isDestroyed()?null:this.enqueueAdEvent(b,e,{preload:!0}))):this.player.once("autostartNotAllowed",(()=>{this.loadPreroll(t).catch((e=>this.isDestroyed()?null:this.enqueueAdEvent(b,e,{preload:!0})))}))}else t.preloadPreroll&&this.loadPreroll(t).catch((e=>this.isDestroyed()?null:this.enqueueAdEvent(b,e,{preload:!0})));return this.bidsPromise}createBidsPromise(t,i){const s=this.player;let a=parseInt(t.bidOnBreaks,10);return a=a>0?a:1/0,this.bids=this.schedule.getAllAds().slice(0,a).map((a=>{const{adPlayId:r}=this.getAdIds(a),n=s.getConfig(),{skipoffset:l}=this.config,o=null!=l&&l>=0,d=be(s,this.item),h={id:r,offset:t.offset,jwpseg:d,placement:ke(n),tag:a._adQueue?a._adQueue[0]:a._currentTag,adClient:this.client};this.client===e&&(h.skipoffset=o?l:-1);const c=this.bidding.createNewBid(h,{getURLParts:we});this.player.trigger("adBidRequest",Ce(this,a,Object.assign({jwpseg:d},i))),c.init();const p=c.start().then((({result:t})=>{if(this.isDestroyed())return;let s=Promise.resolve();var r;t&&!t.error&&(a.jwpseg=d,t.adm?(a._adXML=t.adm,null!=a&&null!=(r=a._adQueue)&&r.length&&a._adQueue.unshift(t.adm)):t.tag&&(s=Me(t.tag,this.player,this.item,this.client,{},a).then((t=>{this.client===e?(a._adQueue=a._adQueue||[],a._adQueue.unshift(t)):a._adQueue=[t]}))));return this.player.trigger("adBidResponse",Ce(this,a,i)),s}));return this.bidsPromises.push(p),c})),Promise.all(this.bidsPromises)}checkPreroll(e){if(this.bidTimeoutStarted||(this.bidTimeoutStarted=!0,this.bids.forEach((e=>e.timeout()))),this.casting||this.preRollPlayed||this.adRules.shouldDeferAds())return;this.preRollPlayed=!0;const t=(null==e?void 0:e.startTime)||this.player.getPosition();this.lastTimeEvent=t||this.lastTimeEvent;const i=this.schedule.getPreRoll(t);if(!i&&!this.vmapPromise)return;(null!==this.vmapPromise||i&&"nonlinear"!==i._type)&&this.startBlocking(),this.bidsPromise.then((()=>{if(this.isDestroyed())return;const e=this.schedule.getPreRoll(t);e&&"nonlinear"!==e._type&&this.triggerAdBreakEvents(e,"pre")})),t?"none"===this.adRules.startOnSeek&&(this.prerollPromise=null):this.adRules.clearStartOnSeek();const s=null!=e&&e.playReason?e.playReason:c;this.playPreroll({adBlock:this.adBlockErrorDetected,startTime:t,reason:s})}checkMidrolls(e){if(this.casting||0===e.duration||this.adRules.shouldDeferAds())return;const t=this.schedule.getNextMidrollIndex(this.lastTimeEvent,e.position,e.duration);if(this.lastTimeEvent=e.position,null!==t){if(this.isAdLoading)return;const e=this.schedule.getMidRollAtIndex(t);"nonlinear"!==e._type&&(this.startBlocking(),this.triggerAdBreakEvents(e,"mid")),this.playMidrollAtIndex(t,{adBlock:this.adBlockErrorDetected})}else if(!this.preRollPlayed&&this.schedule.getClosestIndex(e.position,e.duration)<0)this.checkPreroll(e);else if(this.config.preloadAds){const t=e.position+5,i=this.schedule.peek(e.position,t,e.duration);if(null!==i&&i>=0)this.loadMidrollAtIndex(i,{adBlock:this.adBlockErrorDetected,preload:!0}).catch((e=>this.logger.debug(e)));else if(-1===i){const t=ye()+1e3*(e.duration-e.position);this.loadPostroll({adBlock:this.adBlockErrorDetected,preload:!0,startTime:t}).catch((e=>this.logger.debug(e)))}else if(null===this.next&&null===this.nextPlaylistItemPromise&&t>e.duration){const e=this.player.getPlaylistIndex()+1,t=this.player.getPlaylistItem(e);if(this.nextPlaylistRelated=Boolean(this.relatedNextUp),t||this.relatedNextUp){const t=this.relatedNextUp?-1:e;this.nextPlaylistItemPromise=Promise.resolve(this.player.getPlaylistItemPromise(t)).then((()=>{this.isDestroyed()||(this.trigger("preloadNext",{item:this.player.getPlaylistItem(e)||this.relatedNextUp,index:t}),this.relatedNextUp=null,this.nextPlaylistItemPromise=null)})).catch((e=>this.logger.debug(e)))}}}}checkPostrolls(e){if(this.casting||this.adRules.shouldDeferAds()||this.isDestroyed())return;const t=this.schedule.getPostRoll();t&&("nonlinear"!==t._type&&(this.startBlocking(),this.triggerAdBreakEvents(t,"post")),this.playPostroll(e))}getAdIds(e,{tagIndex:t,podIndex:i}={}){let s=e.adRequestIds&&void 0!==t?e.adRequestIds[t]:null;if(!s){const t=`p${i||e._adPodIndex||0}w${e._waterfallIndex||0}`;"p0w0"===t?s=e.adBreakId:(e.adPlayIds=e.adPlayIds||{},s=e.adPlayIds[t]=e.adPlayIds[t]||this.player.utils.genId(12))}return{adBreakId:e.adBreakId,adPlayId:s}}loadPreroll(e={}){return this.prerollPromise||(this.prerollPromise=this.bidsPromise.then((()=>{if(this.isDestroyed())return;const t=this.schedule.getPreRoll(e.startTime);return t?(t._position="pre",t._preload=!0,this.loadAd(t,e)):void 0}))),this.prerollPromise}loadMidrollAtIndex(e,t){return this.midrollPromise[e]||(this.midrollPromise[e]=this.bidsPromise.then((()=>{if(this.isDestroyed())return;const i=this.schedule.getMidRollAtIndex(e);return i?(i._position="mid",i._preload=!0,this.loadAd(i,t)):void 0}))),this.midrollPromise[e]}loadPostroll(e={}){return this.postrollPromise||(this.postrollPromise=this.bidsPromise.then((()=>{if(this.isDestroyed())return;const t=this.schedule.getPostRoll(e.startTime);return t?(t._position="post",t._preload=!0,this.loadAd(t,e)):void 0}))),this.postrollPromise}playPreroll(e){this.prerollPromise?this.playPreloadedPromise(this.prerollPromise,e):this.bidsPromise.then((()=>{if(this.isDestroyed())return;const t=this.schedule.getPreRoll(e.startTime);t?(t._position="pre",this.startAdBreak(t,e)):this.stopBlocking()}))}playMidrollAtIndex(e){this.midrollPromise[e]?this.playPreloadedPromise(this.midrollPromise[e]):this.bidsPromise.then((()=>{const t=this.schedule.getMidRollAtIndex(e);t&&(t._position="mid",this.startAdBreak(t))}))}playPostroll(e){this.postrollPromise?this.playPreloadedPromise(this.postrollPromise):this.bidsPromise.then((()=>{const t=this.schedule.getPostRoll();t&&(t._position="post",this.startAdBreak(t,e))}))}isDestroyed(){return null===this.player}destroy(){this.destroyBids(),this.player.off(null,null,this),this.player=null}destroyBids(){this.bids.forEach((e=>e.stop())),this.bidsPromises=[],this.bids=[]}enqueueAdEvent(e,t,i){this._events.push({type:e,event:t}),i.preload||this.dequeueAdEvents()}async waitForAdPlay(e){this.isAdLoading=!0;let t=!1;try{await e,t=!0}catch(e){var i;null==(i=this.logger)||i.debug(e)}return this.isAdLoading=!1,t}dequeueAdEvents(){}triggerAdBreakEvents(){}startBlocking(){}stopBlocking(){}loadAd(){}playPreloadedPromise(){}startAdBreak(){}}class dt{constructor(e,t,i,s,a,r,n){Object.assign(this,e.Events),this.player=e,this.startingSize=e.getWidth()*e.getHeight(),this.logger=e.utils.logger.child("ads-vast/OmidTracker");const l=r.allowedOmidVendors;try{const o=[];s.forEach((e=>{const{javaScriptResource:i,vendor:s,verificationParameters:a,trackers:d}=e;l.length&&l.indexOf(s)<0?n("verificationNotExecuted",d.verificationNotExecuted,{"[REASON]":1}):i?i.url?o.push(new t.VerificationScriptResource(i.url,s,a,r.omidAccessMode)):n("verificationNotExecuted",d.verificationNotExecuted,{"[REASON]":3}):n("verificationNotExecuted",d.verificationNotExecuted,{"[REASON]":2})}));const d=new t.Partner("JWPlayer",e.version),h=new t.Context(d,o,location.href);h.setVideoElement(i),h.underEvaluation=!0,h.setServiceWindow(window);const c=this.adSession=new t.AdSession(h);if(!c.isSupported())return;this.adEvents=new t.AdEvents(c),this.mediaEvents=new t.MediaEvents(c),a&&c.setCreativeType("video"),c.start()}catch(e){return this.logger.warn(e),null}}resetResizeTimeout(){clearTimeout(this.resizeTimer),this.isFullscreen||(this.resizeTimer=setTimeout((()=>{if(this.mediaEvents){const e=this.player.getWidth(),t=this.player.getHeight();e*t>this.startingSize?this.mediaEvents.playerStateChange("expanded"):e*t<this.startingSize?this.mediaEvents.playerStateChange("collapsed"):this.mediaEvents.playerStateChange("normal")}}),250))}trackEvent(e,...t){if(this.adEvents&&this.mediaEvents)try{switch(e){case _:this.adEvents.loaded();break;case"click":this.mediaEvents.adUserInteraction("click");break;case"close":this.finishSession();break;case"complete":this.mediaEvents.complete(),this.finishSession();break;case"firstQuartile":this.mediaEvents.firstQuartile();break;case"fullscreen":this.isFullscreen=t[0],this.resetResizeTimeout(),this.isFullscreen&&this.mediaEvents.playerStateChange("fullscreen");break;case"impression":this.mediaEvents.start(...t),this.adEvents.impressionOccurred(),this.startingSize=this.player.getWidth()*this.player.getHeight(),this.isFullscreen=this.player.getFullscreen();break;case"midpoint":this.mediaEvents.midpoint();break;case"mute":this.mediaEvents.volumeChange(0);break;case"pause":this.mediaEvents.pause();break;case"resize":this.resetResizeTimeout();break;case"resume":this.mediaEvents.resume();break;case"skip":this.mediaEvents.skipped(),this.finishSession();break;case"thirdQuartile":this.mediaEvents.thirdQuartile();break;case"unmute":this.mediaEvents.volumeChange(this.player.getVolume()/100);break;case"volume":this.mediaEvents.volumeChange(...t);break;case"bufferStart":this.mediaEvents.bufferStart();break;case"bufferFinish":this.mediaEvents.bufferFinish()}}catch(e){this.logger.warn(e),this.adEvents=this.mediaEvents=null}}finishSession(){this.adSession&&(this.adSession.finish(),this.adSession=null,this.adEvents=null,this.mediaEvents=null)}}const ht={};function ct(e,t){if(ht[t])return ht[t];"file:"===document.location.protocol&&0===t.indexOf("//")&&(t=`https:${t}`);const i=new(0,e.scriptloader)(t);return ht[t]=i.load(),ht[t]}const pt="1.4.12",ut=`//ssl.p.jwpcdn.com/player/lib/omid/v/${pt}/omid-session-client-v1.js`,mt=`//ssl.p.jwpcdn.com/player/lib/omid/v/${pt}/omweb-v1.js`;let gt=null,yt=null;const ft=e=>{var t,i;yt||(yt=null!=(t=window)&&null!=(i=t.OmidSessionClient)&&i.default?Promise.resolve():ct(e,ut));return gt||(gt=ct(e,mt)),Promise.all([gt,yt])};var vt=function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Object.prototype.hasOwnProperty.call(Object(e),t)};const Pt=[];class At{constructor({adServingId:e,adVerifications:t,linear:i},s,a,r,n,l){const o=s||{};this.adServingId=e,this.map=o,this.omidDeferredEvents=[],l&&t&&"disabled"!==n.omidSupport&&(l.on(_,(()=>{l.off(null,null,this),this.trackOmidEvent(_)}),this),ft(r.utils).then((()=>{const e=window.OmidSessionClient.default,s=l.getMediaElement();this.omidTracker=new dt(r,e,s,t,i,n,this.trackPingsByUrl.bind(this)),this.omidDeferredEvents.forEach((e=>{const{type:t,args:i}=e;this.trackOmidEvent(t,...i)})),this.omidDeferredEvents=[]}))),this.debugTrackFn=a,this.trackerPlayerUtils=function(e){return{getPosition:()=>e.getPosition(),getFile:()=>e.getPlaylistItem().file,getPlacement:()=>ke(e.getConfig()),getUserAgent:()=>navigator.userAgent}}(r),this.trackingFilter=n.trackingFilter,this.lastQuartile=0,this.progressEvents=[],this.breakStarted=!1,this.started=!1,this.firedError=!1,this.hasComp=!1,this.buffering=!1,Object.keys(o).forEach((e=>{if(vt(o,e)&&0===e.indexOf("progress")){const t=`${e.split("_")[1]}`,i={key:e,offset:t,tracked:!1,percentage:!1};/^\d+%$/.test(t)?(i.percentage=!0,i.offset=parseFloat(t)):i.offset=r.utils.seconds(t),this.progressEvents.push(i)}})),this.setFactories()}getUrls(e){return vt(this.map,e)?this.map[e]:[]}addUrl(e,t){vt(this.map,e)||(this.map[e]=[]),this.map[e].push(t)}trackPingsByUrl(e,t,i={}){const{trackingFilter:s}=this,a=[],r=[],n=[];if(t.length){i=this.replaceMacros(i),t.forEach((e=>{if(!e)return;if(Object.keys(i).forEach((t=>{e=e.replace(t,i[t])})),s&&!1===s(e))return void r.push(e);const t=new Image;t.src=e,a.push(e),n.push(t)})),Array.prototype.push.apply(Pt,n);let e=Pt.length;for(;e--&&(Pt[e].width||Pt[e].complete);)Pt.length=e}"function"==typeof this.debugTrackFn&&this.debugTrackFn({type:"ping",data:{pingType:e,urls:a,filteredUrls:r,images:n}})}trackPings(e,t){const i=this.getUrls(e);this.trackPingsByUrl(e,i,t)}trackOmidEvent(e,...t){this.omidTracker?this.omidTracker.trackEvent(e,...t):this.omidDeferredEvents.push({type:e,args:t})}replaceMacros(e){const{gdprApplies:t,consentData:i}=Pe;return e["[ADSERVINGID]"]=encodeURIComponent(this.adServingId||""),e["[ASSETURI]"]=encodeURIComponent(this.trackerPlayerUtils.getFile()),e["[CACHEBUSTING]"]=Math.random().toString().slice(2,10),e["[CONTENTPLAYHEAD]"]=encodeURIComponent(function(e){const t=`0${Math.floor(e/3600)}`.slice(-2),i=`0${Math.floor((e-3600*t)/60)}`.slice(-2);return`${t}:${i}:${`0${Math.floor(e-3600*t-60*i)}`.slice(-2)}.${(e%1).toFixed(3).toString().slice(2,5)}`}(this.trackerPlayerUtils.getPosition())),e["[DEVICEUA]"]=encodeURIComponent(this.trackerPlayerUtils.getUserAgent()),e[m]=i,e["[PAGEURL]"]=encodeURIComponent(we().url),e["[PLACEMENTTYPE]"]=this.trackerPlayerUtils.getPlacement(),e[g]=t?"gdpr":"",e["[TIMESTAMP]"]=encodeURIComponent(function(){const e=new Date,t=e.getTime(),i=e.getTimezoneOffset()/60,s=6e4*e.getTimezoneOffset();return new Date(t-s).toISOString().slice(0,-1)+(i>0?"-":"+")+`0${i}`.slice(-2)}()),e}start(){this.started=!0,this.trackPings("start")}breakStart(){this.breakStarted=!0,this.trackPings("breakStart")}time(e,t){if(t<=1)return;const i=(4*e+.05)/t|0;for(;i>this.lastQuartile&&this.lastQuartile<3;)this.lastQuartile++,1===this.lastQuartile?(this.trackPings("firstQuartile"),this.trackOmidEvent("firstQuartile")):2===this.lastQuartile?(this.trackPings("midpoint"),this.trackOmidEvent("midpoint")):3===this.lastQuartile&&(this.trackPings("thirdQuartile"),this.trackOmidEvent("thirdQuartile"));this.trackProgress(e,t)}trackProgress(e,t){for(let i=this.progressEvents.length;i--;){const s=this.progressEvents[i];if(!s.tracked){let i=s.offset;s.percentage&&(i=t*i/100),e>=i&&(s.tracked=!0,this.trackPings(s.key))}}}error(e=900){this.firedError=!0;const t={};t[u]=e,this.trackPings("error",t)}factory(e){return(...t)=>{this.trackPings(e),"fullscreen"!==e&&this.trackOmidEvent(e,...t)}}setFactories(){this.creativeView=this.factory("creativeView"),this.click=this.factory("click"),this.skip=this.factory("skip"),this.complete=this.factory("complete"),this.pause=this.factory("pause"),this.resume=this.factory("resume"),this.mute=this.factory("mute"),this.unmute=this.factory("unmute"),this.fullscreen=this.factory("fullscreen"),this.expand=this.factory("expand"),this.collapse=this.factory("collapse"),this.acceptInvitation=this.factory("acceptInvitation"),this.close=this.factory("close"),this.rewind=this.factory("rewind"),this.impression=this.factory("impression"),this.viewable=this.factory("viewable"),this.notViewable=this.factory("notviewable"),this.breakEnd=this.factory("breakEnd")}}const kt=(e,t)=>{const i=[];return t.forEach((t=>{var s,a;e.companions&&(t.companions=(t.companions?t.companions:[]).concat(e.companions)),e.trackers&&(t.trackers=(s=t.trackers,a=e.trackers,s=s||{},Object.keys(a).forEach((e=>{const t=a[e];s[e]?s[e]=s[e].concat(t):s[e]=t})),s)),e.sequence&&(t.sequence=e.sequence),e._currentTag&&(t._currentTag=e._currentTag),e.adVerifications&&(t.adVerifications=(t.adVerifications?t.adVerifications:[]).concat(e.adVerifications)),e.adId&&(t.adIds=(t.adIds||[]).concat(e.adId)),i.push(t)})),i};class wt{constructor(e,t,i,s,a,r){this._scheduledAd=e,this.player=t,this.options=i,this.item=i.item,this.params=i.params||{},this.wrapperOptions=s||{},this.logger=t.utils.logger.child("ads-vast/VastLoader"),"boolean"!=typeof this.wrapperOptions.followAdditionalAds&&(this.wrapperOptions.followAdditionalAds=!0),"boolean"!=typeof this.wrapperOptions.allowMultipleAds&&(this.wrapperOptions.allowMultipleAds=!0),this.debugTrackFn=a,Object.assign(this,t.Events),this._history=[],this.loadedAds=[],this.parser=null,this.promise=null,this.xmlhttp=null,this.wrappedTags=null,this.options.isPodItemLoader||(e.adPlayIds={}),this.extensionHandlers=Object.assign({},window.jwVastExtensionHandlers,this.params.extensions),this.mock=r||!1}load(e){if(null===this.promise){this._history.push(e);const{requestFilter:t}=this.options;this.promise=new Promise(((i,s)=>{this.xmlhttp=this.player.utils.ajax({url:e,withCredentials:this.params.withCredentials,retryWithoutCredentials:!0,requireValidXML:!0,timeout:this._scheduledAd.requestTimeout,requestFilter:t},i,((e,t,i,a)=>s(a)))})).catch((t=>{if(null!==this.player)throw this.ajaxError(t,e)})).then((t=>{if(null!==this.player){const i=t.responseXML||t.responseText;return this.trigger(E,{tag:e,xml:i}),this.parseVast(i,e)}}))}return this.promise}destroy(){var e;(e=this.xmlhttp)&&(e.onload=null,e.onreadystatechange=null,e.onerror=null,e.abort&&e.abort()),this.off(),this.player=null,this.xmlhttp=null}scheduledAd(){return this._scheduledAd}allAds(){return this.loadedAds}podMultipleVastLoaders(e){const t=e.map((e=>e.then((e=>{const t=e.adPod();if(t.length)return t;const i=e.adBuffet();return i.length?[i[0]]:Promise.reject({vloader:this,message:"No compatible ad"})})).catch((e=>({error:e})))));return Promise.all(t).then((e=>{let t=0;const i=e.reduce(((e,i,s)=>{if(i.error)return i.error.tagIndex=s,this.trigger(L,i.error),e;if(i.length&&0!==s){const e=`p${t}w${this._scheduledAd._waterfallIndex}`;this._scheduledAd.adPlayIds[e]=this._scheduledAd.adRequestIds[s]}return i.forEach((i=>{i.sequence=++t,e.push(i)})),e}),[]);return i.length?(this.loadedAds=i,this):null}))}adPod(){const e=[];return this.loadedAds.forEach((t=>{t.sequence&&e.push(t)})),e.sort(((e,t)=>e.sequence-t.sequence)),e}adBuffet(){const e=[];return this.loadedAds.forEach((t=>{t.sequence||e.push(t)})),e}parseVast(e,t){return this.parseXMLString(e,t).then((e=>this.checkForWrappers(e,t))).then((e=>this.checkExtensionHandlers(e)))}parseXMLString(e,t){return null===this.parser&&(this.parser=new Ke(null,this.player.utils)),new Promise((t=>{const i=(s=e,("object"==typeof Node?s instanceof Node:s&&"object"==typeof s&&"number"==typeof s.nodeType&&"string"==typeof s.nodeName)?e:this.player.utils.parseXML(e));var s;if(null===i){throw{message:"Invalid XML",code:100}}return t(this.parser.parse(i,this.xmlhttp))})).catch((e=>{if(null!==this.player){const i=e.code||900,s=e.adErrorCode||1e4+i;throw this.sendErrorEvent(e.message,i,s,t)}}))}checkForWrappers(t,i){if(null===this.player)return null;if(0===t.length)throw this.sendErrorEvent("No ads",303,10303,i);const s=t.filter((e=>!e.sequence)).map((e=>(e._currentTag=i,e)));this.wrapperOptions.allowMultipleAds?this.loadedAds=t:this.loadedAds=s,this.options.wrapper=this.options.wrapper||[],this.options.wrapperAdIds=this.options.wrapperAdIds||[];const{adsystem:a,dealId:r,adId:n}=this.options;a&&this.options.wrapper.push(a),n&&this.options.wrapperAdIds.push(n),r&&(this.options.wrapperDealId=r),this.options.adsystem=this.loadedAds[0].adsystem,this.options.dealId=this.loadedAds[0].dealId;const l=[];return t.forEach(((t,a)=>{if(t._currentTag||(t._currentTag=i),t.wrappedURI){if(!1===this.wrapperOptions.followAdditionalWrappers)return;this.options.wrappedTags=this.options.wrappedTags||[this._scheduledAd._currentTag],this.options.wrappedTags.push(t.wrappedURI);const i=new wt(this._scheduledAd,this.player,this.options,{fallbackOnNoAd:t.fallbackOnNoAd,allowMultipleAds:t.allowMultipleAds,followAdditionalWrappers:t.followAdditionalWrappers},this.debugTrackFn);i.on(E,(e=>{this.trigger(E,e)}),this);const r=Me(t.wrappedURI,this.player,this.item,e,this.params,t).then((e=>i.load(e))).then((e=>{i.off(E,null,this);const s=kt(t,e.allAds()),a=this.loadedAds.indexOf(t);Array.prototype.splice.apply(this.loadedAds,[a,1].concat(s))})).catch((e=>{i.off(E,null,this);const r=this.sendAdpodErrorEvent(e,t,a),n=t.fallbackOnNoAd&&t.sequence&&s.length,l=this.loadedAds.indexOf(t);if(n)return t.loadError=r,void e.vloader.destroy();if(this.loadedAds.splice(l,1),e.vloader.destroy(),r.type!==L)throw r;this.trigger(L,r)}));l.push(r)}else this.options.wrapper.length&&(t.wrapper=this.options.wrapper,t.wrappedTags=this.options.wrappedTags,t.wrapperAdIds=this.options.wrapperAdIds,t.dealId=this.options.wrapperDealId)})),Promise.all(l)}checkExtensionHandlers(){if(null===this.player)return null;const e=this.loadedAds.filter((e=>!e.sequence));return this.loadedAds.extensionNodes&&(this.loadedAds=this.handleExtensionCallback(this.loadedAds)),this.loadedAds.forEach(((t,i)=>{if(t.loadError)if(e.length){const s=this.loadedAds[i+1],a=s&&!s.sequence?s:e[0];this.loadedAds[i]=Object.assign({},a,{sequence:t.sequence})}else this.trigger(L,t.loadError)})),this.validateAdResponses()}validateAdResponses(){const e=this.loadedAds.slice(0),t=e.length;e.forEach((t=>{t.media&&t.media.length||e.length--}));const i=0===t,s=e.length!==t;if((i||s)&&!this.mock)throw this.sendErrorEvent("Ad Tag Empty",101,10101,this._history[this._history.length-1]);return this}handleExtensionCallback(e){for(const s in this.extensionHandlers){var t,i;if(null!=(t=e)&&null!=(i=t.extensionNodes)&&i[s]){e=e.extensionNodes[s].reduce(((e,t)=>{try{e=this.extensionHandlers[s](e,t)}catch(e){this.logger.debug("Error with handling extension callback function: ",e)}return e}),e)}}return e}ajaxError(e,t){var i,s;if(this.player.getAdBlock())return this.sendErrorEvent("Ad playback blocked by an ad blocker",900,60003,t);const a=e.code;if(601===a||602===a)return this.sendErrorEvent("Invalid XML",100,10100,t);const r=null==this||null==(i=this.options)||null==(s=i.wrappedTags)?void 0:s.length,n=r?301:900,l=r?10301:60006;return this.sendErrorEvent(e.message||"Error loading file",n,l,t)}firstUrl(){var e;return null!=this&&null!=(e=this._history)&&e.length?this._history[0]:""}sendAdpodErrorEvent(e,t,i){const{message:s,code:a,adErrorCode:r,url:n}=e;if(1===this.loadedAds.length)return this.sendErrorEvent(s,a,r,n,i);const l={message:s,code:a,adErrorCode:r,podIndex:i,vloader:this,tag:this.firstUrl()||n,type:L};return this.trackError(l,t),this.wrappedTags=n,l}sendErrorEvent(e,t,i,s,a){const r={message:e,code:t,adErrorCode:i,podIndex:a,vloader:this,tag:this.firstUrl()||s,adsystem:this.options.adsystem||""};return this.options.wrappedTags&&(r.wrapperAdSystem=this.options.wrapper||"",r.wrappedTags=this.options.wrappedTags,r.wrapperAdIds=this.options.wrapperAdIds),this.trackError(r),r}trackError(e,t){const i=e.vloader.allAds();if(null!=i&&i.length){const s=t||i[0];if(s){const t=s.trackers;if(null!=t&&t.error){new At(s,t,this.debugTrackFn,this.player,this.options).error(e.code)}}}}}class bt{constructor(e,t,i,s,a){this.player=e,this.state=e.state,this.vpaidURL=i,this.adTag=s,this.adParams=a.adParams,this.vpaidControls=a.vpaidControls,this.remainingTimeInterval=null,this.type="vpaid",this.instream=t||e.createInstream(),this.vpaidState={linear:!1,expanded:!1,remainingTime:-1},this.paused=!1,Object.assign(this,e.Events),this.setMuteCallback=()=>{this.handleMute?this.setMute():this.handleMute=!0},this._forceUnpause=()=>{this.vpaidAd&&!this.paused&&this._mediaEl&&!this._mediaEl.ended&&(this.player.setMute(!0),this.vpaidAd.resumeAd())},this.playerContainer=this.player.getContainer(),a.adOptOut?setTimeout((()=>{this.sendEvent("error",{message:"Conditional ad rejected",code:408})}),0):this.iframe=((e,t,i,s)=>{const a=document.createElement("iframe");return a.onload=s,a.setAttribute("allow","autoplay"),a.srcdoc=`\n    <html style="height: 100%">\n      <body style="margin: 0; height: 100%">\n        <script src="${t}" ><\/script>\n      </body>\n    </html>`,a.classList.add("jw-vpaid-iframe"),a.scrolling="no",i.querySelector(".jw-media").appendChild(a),a})(e.utils,this.vpaidURL,this.playerContainer,this.callback.bind(this))}_listenForForcedPause(){var e,t;(this._stopListeningForForcedPause(),this._mediaEl)||(this._mediaEl=null==(t=this.instream)?void 0:t.getMediaElement());null==(e=this._mediaEl)||e.addEventListener("pause",this._forceUnpause,{once:!0})}_stopListeningForForcedPause(){var e;null==(e=this._mediaEl)||e.removeEventListener("pause",this._forceUnpause)}sendEvent(e,t){(t=t||{}).tag||(t.tag=this.adTag),this.trigger(e,t)}sendTimeEvent(e,t,i){const s=t.getAdDuration(),a=t.getAdRemainingTime(),r=Object.assign({duration:s},i);this.sendEvent(e,r),a>0&&(r.position=s-a,this.trigger("time",r))}handleQuartile(e,t){this.sendTimeEvent("quartile",e,{quartile:t})}genEvent(e){return t=>{this.on(e,t)}}setMute(){const e=0===this.vpaidAd.getAdVolume();this.player.getMute()!==e&&this.player.setMute(e),!1===e&&this._listenForForcedPause()}prepareNonlinearAd(){if(this.player.utils.style(this.iframe,{height:150}),this.iframe.classList.add("jw-vpaid-non-linear"),this.resize(null,150),this.instream){this.instream.noResume=!0,this.instream.applyProviderListeners(null),this.instream.destroy(),this.instream=null;const e=this.playerContainer.querySelector(".jw-media"),t=e.querySelector("video,audio");e.insertBefore(t,this.iframe),t.play()}}progressInterval(e){if(clearInterval(this.remainingTimeInterval),!e||!e.getAdRemainingTime)return;let t=-1;this.remainingTimeInterval=setInterval((()=>{if(this.paused)return;const i=e.getAdRemainingTime();isNaN(i)||i<=0||t===i||(t=i,this.sendTimeEvent("remainingTimeChange",e,{remainingTime:i}))}),250)}genListeners(e){return{AdLoaded:()=>{e.setAdVolume(this.getPlayerVolume()),e.startAd()},AdStarted:()=>{const t=e.getAdDuration?e.getAdDuration():0,i=!e.getAdLinear||e.getAdLinear(),s=i?"linear":"nonlinear";if(i){this.instream=this.instream||this.player.createInstream(),this.vpaidControls||this.instream.hide();const t=this.instream.getMediaElement();this.player.getPip()&&this.player.requestPip(t),this.progressInterval(e)}else this.prepareNonlinearAd();this.sendEvent("impression",{linear:s,duration:t}),this.sendEvent("play",{oldstate:"buffering",newstate:a,linear:s}),this.handleMute=!0,e.subscribe(this.setMuteCallback,"AdVolumeChange",e)},AdVideoStart:()=>{this.sendEvent("started")},AdStopped:()=>{this.sendEvent("stopped")},AdPaused:()=>{this.paused||(this.paused=!0,this.sendEvent("pause",{newstate:s,oldstate:a}))},AdPlaying:()=>{if(this.paused){const t=!e.getAdLinear||e.getAdLinear()?"linear":"nonlinear";this.paused=!1,this.sendEvent("play",{newstate:a,oldstate:s,linear:t})}},AdLinearChange:()=>{!e.getAdLinear||e.getAdLinear()?(this.player.utils.style(this.iframe,{height:"100%"}),this.player.off(null,null,this),this.instream=this.instream||this.player.createInstream(),this.instream.init(),this.vpaidControls||this.instream.hide()):(this._stopListeningForForcedPause(),this.prepareNonlinearAd())},AdDurationChange:()=>{this.sendTimeEvent("remainingTimeChange",e,{isDurationChange:!0,remainingTime:e.getAdRemainingTime()})},AdRemainingTimeChange:()=>{this.paused||this.sendTimeEvent("remainingTimeChange",e,{remainingTime:e.getAdRemainingTime()})},AdExpandedChange:()=>{this.sendEvent("expandedChange",{expanded:e.getAdExpanded()})},AdSkippableStateChange:()=>{this.sendEvent("skippableStateChange",{skippable:e.getAdSkippableState()})},AdSkipped:()=>{this._stopListeningForForcedPause(),this.sendEvent("skipped")},AdVideoFirstQuartile:()=>{this.handleQuartile(e,1)},AdVideoMidpoint:()=>{this.handleQuartile(e,2)},AdVideoThirdQuartile:()=>{this.handleQuartile(e,3)},AdVideoComplete:()=>{this._stopListeningForForcedPause(),this.sendEvent("complete")},AdUserClose:()=>{this._stopListeningForForcedPause(),this.sendEvent("close")},AdClickThru:(e,t,i)=>{this.sendEvent("click",{id:t,url:e,playerHandles:i})},AdError:e=>{this._stopListeningForForcedPause();const t=(e=>{if(e){const t=e.match(/\b(?:[34])[0-9]{2}\b/);if(t)return parseInt(t[0],10);if(e.match(/timeout/i))return e.match(/vpaid|vast/i)?301:402;if(e.match(/found/i))return 401;if(e.match(/supported/i))return 403;if(e.match(/(?:displaying|media file)/i))return 405}return 901})(e);this.sendEvent("error",{message:e,code:t,adErrorCode:5e4+t})}}}callback(){try{this.vpaidAd=this.iframe.contentWindow.getVPAIDAd();const e=this.vpaidAd.handshakeVersion("2.0");if(parseFloat(e)<1)throw new Error("Invalid vpaid version in handshake")}catch(e){return void this.sendEvent("error",{message:e.message||"VPAID general error",code:901,adErrorCode:51901})}const e=this.vpaidAd,t=this.genListeners(e);Object.keys(t).forEach((i=>{e.subscribe(t[i],i,e)})),this.listeners=t;const i={AdParameters:this.adParams},s=this.iframe.contentWindow.document.createElement("div");s.className="jw-vpaid-wrapper",s.style.height="100%",this.iframe.contentWindow.document.body.appendChild(s),this.vpaidURL.indexOf("//imasdk.googleapis.com/js/sdkloader/vpaid_adapter.js")>=0&&(this.iframe.contentWindow.HTMLVideoElement=HTMLVideoElement);const a={videoSlot:this.instream.getMediaElement(),slot:s};e.initAd(this.player.getWidth(),this.player.getHeight(),"normal",1e3,i,a),e.setAdVolume(this.getPlayerVolume())}play(){this.vpaidAd.resumeAd()}pause(){this.vpaidAd.pauseAd()}skip(){return!(!this.vpaidAd.skipAd||!this.vpaidAd.getAdSkippableState())&&(this.vpaidAd.skipAd(),!0)}stop(){if(this.vpaidAd)try{this.vpaidAd.stopAd()}catch(e){}}getPlayerVolume(){return this.player.getMute()?0:this.player.getVolume()/100}setVolume(e){this.handleMute=!1,this.vpaidAd.setAdVolume(e/100)}resize(e,t){var i;if(null!=(i=this.vpaidAd)&&i.resizeAd){const i=this.player.getFullscreen()||document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen?"fullscreen":"normal";this.vpaidAd.resizeAd(e||this.player.getWidth(),t||this.player.getHeight(),i)}}destroy(){if(this._stopListeningForForcedPause(),this.removeEvents(),clearInterval(this.remainingTimeInterval),this.vpaidAd)try{const e=this.listeners,t=this.vpaidAd;Object.keys(e).forEach((i=>{t.unsubscribe(e[i],i,t)})),t.unsubscribe(this.setMuteCallback,"AdVolumeChange",t)}catch(e){}setTimeout((()=>{var e;null!=this&&null!=(e=this.iframe)&&e.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}),0),this.vpaidAd=null,this.player=null,this.instream=null}removeEvents(){this.player&&this.player.off(null,null,this),this.off()}attachMedia(){}detachMedia(){}volume(){}mute(){}getState(){return this.vpaidState.linear?this.paused?s:a:"idle"}}class Et{constructor(e,t,i){this.player=e,this.icon=t,this.div=i;const s=this.utils=e.utils;this.images=[],this.iconContainer=((e,t)=>{const i=document.createElement("div");return i.className="jw-ad-icon-container",t.style(i,e),i})(t.style,s);const a=((e,t)=>{const{resourceSource:i,resourceType:s}=e;let a;switch(s){case"iframe":a=document.createElement("iframe"),a.src=i,a.scrolling="no";break;case"html":a=document.createElement("div"),t.replaceInnerHtml(a,i);break;default:a=document.createElement("img"),a.src=i,a.setAttribute("type",s)}return t.addClass(a,"jw-ad-icon"),a})(t.resource,s);this.iconContainer.appendChild(a),i.appendChild(this.iconContainer);const r=1e3*s.seconds(t.offset);r>0?this.showTimeout=setTimeout(this.show.bind(this),r):this.show(),this.ui=new s.UI(this.iconContainer).on("click",this.clickHandler,this)}clickHandler(){this.player.pause({reason:h}),this.sendPing(this.icon.trackers.iconClick),this.utils.openLink(this.icon.clickThrough,"_blank",{rel:"noreferrer"})}show(){clearTimeout(this.showTimeout),this.utils.addClass(this.iconContainer,"jw-ad-icon-active"),this.sendPing(this.icon.trackers.iconView),this.icon.duration&&(this.duration=this.utils.seconds(this.icon.duration),this.beginningPosition=this.utils.seconds(this.icon.offset))}updateTime(e){e-this.beginningPosition>=this.duration&&this.remove()}sendPing(e){if(!e)return;const{images:t}=this,i=new Image;i.src=e;let s=t.length;for(;s--&&(t[s].width||t[s].complete);)t.length=s;t.push(i)}remove(){clearTimeout(this.showTimeout),this.div.contains(this.iconContainer)&&this.div.removeChild(this.iconContainer),this.ui&&(this.ui.destroy(),this.ui=null)}}let It=null,_t=!1;const Tt=(e,t,i,s,a)=>{e.tracker=new At(e,e.trackers,t,i,s,a)},Ct=e=>(e=>"application/javascript"===e.type||"application/x-javascript"===e.type)(e)?"html5":"flash",xt=e=>{let t;for(let i=0;i<e.media.length;i++){const s=e.media[i];if("html5"===Ct(s)){t=s;break}}return t},St=e=>{null!=e&&e.iconInstances&&(e.iconInstances.forEach((e=>{e.remove()})),e.iconInstances=null)};class Rt{constructor(e,t,i){this.player=t,this.playlistItemManager=i;const{staticPlayer:s,companion:a,div:r,optionalParams:n}=i.adPlayerProperties;this.staticPlayer=s,this.companion=a,this.div=r,this.optionalParams=n,this.omidSupport=n.omidSupport,this.debugTrackFn=n.debugTrackFn,this.scheduledAd=e.scheduledAd(),this.vastBuffet=e.adBuffet(),this.vastAdPod=e.adPod(),this.vastAd=this.vastBuffet.length?this.vastBuffet[0]:null,this.adType=null,this.vpaidPlayer=null,this.instreamPlayer=null,this.blockingInstreamPlayer=null,this.mediaType=null,this.adPodItems=null,this.creativeTimeout=null,this.vastOptions=null,this.duration=0,this.position=0,this.initialIndex=0,this.viewablePlayedTime=0,this.adViewableImpressionHandler=t.utils.noop,this.lastPosition=null,this.reason=null,this.logger=t.utils.logger.child("ads-vast/AdPlayer"),Object.assign(this,t.Events)}init(e,t){this.init=function(){throw new Error("Adplayer can only be initialized once")},this.blockingInstreamPlayer=e,this.reason=t;return this.prepareAdPod()?(this.player.on(r,this.playerFullscreenHandler,this),this.player.on(n,this.playerVolumeHandler,this),this.player.on(l,this.muteHandler,this),this.player.on(o,this.playerResizeHandler,this),this.playAd()):Promise.reject()}prepareAdPod(){let e=null,t=0;const i=[];if(this.vastAd&&(Tt(this.vastAd,this.debugTrackFn,this.player,this.optionalParams,this.blockingInstreamPlayer),e=this.prepareAdPodItem(this.vastAd),e&&"vpaid"===e.adType&&!xt(this.vastAd)&&(e=null)),this.vastAdPod){let e=null;for(let s=0;s<this.vastAdPod.length;s++){const a=this.vastAdPod[s];Tt(a,this.debugTrackFn,this.player,this.optionalParams,this.blockingInstreamPlayer);const r=this.prepareAdPodItem(a);if(!r){t++;continue}if(e!==r.adType&&"instream"===e){t++;continue}if(e=r.adType,"vpaid"===r.adType&&!xt(a)){t++;continue}const n=i.length+t===s;r&&n&&i.push(r)}}if(!i.length&&!e)return this.scheduledAd._pod&&this.scheduledAd._pod.length||this.adError("No Compatible Creatives",403),!1;let s;return i.length?(s=i,this.vastOptions=[],s.forEach((e=>{this.vastOptions.push(this.getInstreamOptions(e.vastAd))}))):(s=e,this.vastOptions=this.getInstreamOptions(this.vastAd)),this.adPodItems=s,!0}prepareAdPodItem(e){e.tracker.linear="linear";let t=`${e.media[0].adType}`.toLowerCase()||"instream";"vpaid"!==t||xt(e)||(t="instream");const i={vastAd:e,sources:[],adType:t};void 0!==this.scheduledAd.skipoffset&&(i.skipoffset=this.scheduledAd.skipoffset);const s=e.media,a={};if(s.forEach(((e,t)=>{i.sources.push({file:e.file,mimeType:e.type,type:`${e.type}`.replace(/^(?:video|audio)\/(?:x-)?/,""),id:t}),a[e.file]={width:e.width||0,height:e.height||0,bitrate:e.bitrate||e.maxBitrate,id:t}})),"instream"===t&&(i.sources=(e=>{const t=jwplayer.api.availableProviders.filter((e=>"flash"!==e.name)),i=e.filter((e=>t.some((t=>t.supports(e))))),s=i.filter((e=>"3gpp"!==e.type));return s.length?s:i})(i.sources)),0===i.sources.length)return null;const r=this.player.getSafeRegion(!1).width,n=this.player.getConfig().bandwidthEstimate||5e5,l=function(){const e=n/1e3*.95,t=i.sources.map((e=>a[e.file]));let s=t.filter((e=>e.width>=r)).sort(((e,t)=>e.width-t.width));s.length||(s=t.sort(((e,t)=>t.width-e.width)));const l=s.filter((e=>e.width===s[0].width));if(l.length>1){const t=l.reduce(((t,i)=>i.bitrate<e&&i.bitrate>t.bitrate?i:t)),i=l.reduce(((t,i)=>i.bitrate>=e&&i.bitrate<t.bitrate?i:t));return t||i}return l[0]}().id;return i.vastAd.selectedMedia=i.sources.filter((({id:e})=>e===l))[0],this.mediaType=i.vastAd.selectedMedia.mimeType.toLowerCase(),i.sources=[i.vastAd.selectedMedia],i}getInstreamOptions(e){return{skipoffset:this.getSkipOffset(e),skipmessage:this.optionalParams.skipmessage,skiptext:this.optionalParams.skiptext}}getSkipOffset(e){const t=[this.scheduledAd.skipoffset,this.optionalParams.skipoffset,e.skipoffset].filter((e=>null!=e));return e.skipoffset=t.length?this.player.utils.seconds(t[0]):void 0,e.skipoffset}getVastAd(){var e;const t=this.scheduledAd._adPodIndex;if(this.adPodItems){let e;if(e=this.adPodItems.length?this.adPodItems[t]:this.adPodItems,e.vastAd)return e.vastAd}else if(null!=this&&null!=(e=this.vastAdPod)&&e.length)return this.vastAdPod[t];return this.vastAd}adError(e,t,i){clearTimeout(this.viewableTimeout),this.viewableTimeout=null,clearTimeout(this.creativeTimeout),this.creativeTimeout=null;const s=this.getVastAd();St(s),t=t||900;const a="vpaid"===this.adType?5e4:1e4;i=i||a+t;const r=Object.assign({},this.scheduledAd,s),n={jwpseg:r.jwpseg},l=Te(this.playlistItemManager,{message:e,code:t,adErrorCode:i},r,n);if(this.vastAdPod&&this.scheduledAd._adPodIndex<this.vastAdPod.length-1)return void this.triggerEvent(L,l);s.tracker.error(l.code),this.triggerEvent(V,l),this.removePlayerListeners()}playAd(){const e=this.scheduledAd._adPodIndex,t=this.adPodItems[e]||this.adPodItems;if(this.adType=t.adType,this.blockingInstreamPlayer){const e=this.optionalParams.loadingAd;this.blockingInstreamPlayer.setText(e)}if("vpaid"===this.adType)return this.playVpaid(t.vastAd);if("static"===this.adType)return this.playStatic(),Promise.resolve();const i=Array.isArray(this.adPodItems)?this.adPodItems.slice(e):this.adPodItems,s=Array.isArray(this.vastOptions)?this.vastOptions.slice(e):this.vastOptions;return this.initialIndex=e,this.playInstream(i,s).catch((e=>this.logger.debug(e)))}clearVpaidBlocking(){const e=this.vpaidPlayer.instream;e&&e!==this.blockingInstreamPlayer&&(this.vpaidPlayer.instream=null,this.clearBlocking(e))}clearBlocking(e){(e=e||this.blockingInstreamPlayer)&&e!==this.instreamPlayer&&e.destroy()}getState(){return this.instreamPlayer?this.instreamPlayer.getState():this.vpaidPlayer?this.vpaidPlayer.getState():""}clearNonlinear(){this.staticPlayer.stop(),this.vpaidPlayer&&(this.clearVpaidBlocking(),this.vpaidPlayer&&(this.vpaidPlayer.stop(),this.vpaidPlayer.destroy(),this.vpaidPlayer=null))}destroy(){if(this.off(),this.removePlayerListeners(),clearTimeout(this.viewableTimeout),this.viewableTimeout=null,clearTimeout(this.creativeTimeout),this.creativeTimeout=null,this.instreamPlayer){const e=this.instreamPlayer;this.instreamPlayer=null,this.clearBlocking(e)}this.vpaidPlayer&&(this.clearVpaidBlocking(),this.vpaidPlayer&&(this.vpaidPlayer.destroy(),this.vpaidPlayer=null)),this.clearNonlinear(),St(this.vastAd),this.player=null,this.instreamPlayer=null,this.scheduledAd=null,this.vastBuffet=null,this.vastAd=null,this.vastAdPod=null}pause({reason:e}){this.reason=e||c,this.instreamPlayer?this.instreamPlayer.pause():this.vpaidPlayer&&this.vpaidPlayer.pause()}play({reason:e}){this.reason=e||c,this.instreamPlayer?this.instreamPlayer.play():this.vpaidPlayer&&this.vpaidPlayer.play()}skip(){if(this.instreamPlayer){const e=this.getSkipOffset(this.getVastAd());if(e>0&&this.position<e)return;this.instreamPlayer.skipAd()}else this.vpaidPlayer&&this.vpaidPlayer.skip()}forceSkip(){var e;null!=(e=this.vpaidPlayer)&&e.vpaidAd&&(this.vpaidPlayer.vpaidAd._attributes.skippableState=!0),this.skip()}removePlayerListeners(){this.player&&(this.player.off(r,this.playerFullscreenHandler,this),this.player.off(n,this.playerVolumeHandler,this),this.player.off(l,this.muteHandler,this),this.player.off(d,this.viewableHandler,this),this.player.off(o,this.playerResizeHandler,this)),this.instreamPlayer&&this.instreamPlayer.off(null,null,this),this.vpaidPlayer&&(this.vpaidPlayer.removeEvents(),this.clearVpaidBlocking(),this.vpaidPlayer&&(this.vpaidPlayer.destroy(),this.vpaidPlayer=null)),this.staticPlayer.stop(),this.staticPlayer.removeEvents()}adEventObject(e){var t;const i=this.getVastAd(),s=Object.assign({},this.scheduledAd,i),a=_e(this.playlistItemManager,s);return a.viewable=this.player.getViewable(),null!=this&&null!=(t=this.adPodItems)&&t.length&&(a.sequence=this.scheduledAd._adPodIndex+1,a.podcount=this.adPodItems.length),this.mediaType&&(a.creativetype=this.mediaType),this.scheduledAd._vmap&&(a.vmap=this.scheduledAd._vmap),-1!==X.indexOf(e)&&(a.universalAdId=i.universalAdId,a.categories=i.categories),a}playStatic(){this.vastAd.tracker.linear="nonlinear";const e=this.vastAd.media[0];this.vastAd.selectedMedia=e;const t=this.vastAd.clickthrough||"",i=this.staticPlayer;i.removeEvents(),i.on("play",this.impressionHandler,this),i.on("play",this.playHandler,this),i.on("complete",this.combinedCompleteHandler,this),i.on("click",this.clickStaticHandler,this),i.on("error",this.staticErrorHandler,this),i.playAd(e.file,t,e.minDuration,this.scheduledAd._currentTag,this.scheduledAd.requestTimeout),this.clearBlocking()}creativeAdError(e,t,i){if(this.adError(e,t,i),this.adPodItems&&this.adPodItems.length-1>this.scheduledAd._adPodIndex){if(this.vpaidPlayer&&(this.vpaidPlayer.destroy(),this.vpaidPlayer=null),"instream"===this.adType&&this.instreamPlayer)return void this.instreamPlayer.loadNextItemOnError();this.scheduledAd._adPodIndex++,this.playAd()}}playVpaid(e){clearTimeout(this.creativeTimeout),this.creativeTimeout=setTimeout((()=>{this.creativeAdError("VPAID tag communication timeout",900,50004)}),this.scheduledAd.creativeTimeout),this.vastAd=e;const t=xt(e),i=this.optionalParams.conditionaladoptout&&e.conditionalAd;if(this.vastAd.selectedMedia=t,this.mediaType=t.type,"flash"===Ct(t))return this.creativeAdError("Flash creatives are not supported",403,10403),Promise.reject();const s={adParams:this.vastAd.adParams,vpaidControls:this.optionalParams.vpaidcontrols,adOptOut:i};return this.vpaidPlayer=new bt(this.player,this.blockingInstreamPlayer,t.file,this.scheduledAd._currentTag,s),this.blockingInstreamPlayer&&this.blockingInstreamPlayer.applyProviderListeners(this.vpaidPlayer),this.vpaidPlayer.on("play",this.playHandler,this),this.vpaidPlayer.on("pause",this.pauseHandler,this),this.vpaidPlayer.on("quartile",this.quartileHandler,this),this.vpaidPlayer.on("remainingTimeChange",this.remainingTimeHandler,this),this.vpaidPlayer.on("click",this.clickVpaidHandler,this),this.vpaidPlayer.on("error",this.playbackErrorHandler,this),this.vpaidPlayer.on("impression",this.impressionHandler,this),this.vpaidPlayer.on("expandedChange",this.vpaidExpandedHandler,this),this.vpaidPlayer.on("close",this.adCloseHandler,this),this.vpaidPlayer.on("skipped",this.vpaidAdSkipped,this),this.vpaidPlayer.on("stopped",this.endOfVpaidAdHandler,this),this.vpaidPlayer.on("complete",this.adCompleteHandler,this),this.vpaidPlayer.on("started",this.adStartedHandler,this),this.vpaidPlayer.on("skippableStateChange",this.skippableStateChangeHandler,this),Promise.resolve()}skippableStateChangeHandler(e){e.skippable&&this.blockingInstreamPlayer&&(this.blockingInstreamPlayer.off(N,this.skipVpaidAd,this),this.blockingInstreamPlayer.setupSkipButton(0,this.optionalParams,this.player.utils.noop),this.blockingInstreamPlayer.on(N,this.skipVpaidAd,this))}playInstream(e,t){const i=this.player.getEnvironment().OS;if(i.android&&2===i.version.major&&3===i.version.minor)return this.adError("Android 2.3 not supported",900,60007),Promise.reject();clearTimeout(this.creativeTimeout),this.blockingInstreamPlayer?this.instreamPlayer=this.blockingInstreamPlayer:this.instreamPlayer=this.player.createInstream().init(),this.instreamPlayer.on("play",this.playHandler,this),this.instreamPlayer.on("pause",this.pauseHandler,this),this.instreamPlayer.on("state",this.stateHandler,this),this.instreamPlayer.on("time",this.timeHandler,this),this.instreamPlayer.on("playlistItem",this.playlistItemHandler,this),this.instreamPlayer.on("complete",this.adCompleteHandler,this),this.instreamPlayer.on("playlistComplete",this.endOfAdBreakHandler,this),this.instreamPlayer.on("mute",this.muteHandler,this),this.instreamPlayer.on("instreamClick",this.clickInstreamHandler,this),this.instreamPlayer.on("adSkipped",this.adSkipped,this),this.instreamPlayer.on("error",this.playbackErrorHandler,this),this.instreamPlayer.on("mediaError",this.playbackErrorHandler,this),this.instreamPlayer.on("destroyed",(()=>{this.instreamPlayer=null}),this);const s=this.instreamPlayer.loadItem(e,t);return this.clearBlocking(),s}playerFullscreenHandler(e){const t=this.getVastAd().tracker;t.trackOmidEvent(r,e.fullscreen),e.fullscreen&&t.started&&t.fullscreen()}playerResizeHandler(e){this.getVastAd().tracker.trackOmidEvent("resize",e.width,e.height),this.vpaidPlayer&&this.vpaidPlayer.resize(e.width,e.height)}playerVolumeHandler(e){this.getVastAd().tracker.trackOmidEvent("volume",e.volume/100),this.vpaidPlayer&&this.vpaidPlayer.setVolume(e.volume)}playlistItemHandler(e){this.instreamPlayer&&(clearTimeout(this.creativeTimeout),this.creativeTimeout=setTimeout((()=>{this.creativeAdError("Video creative timeout",402,10402)}),this.scheduledAd.creativeTimeout),this.scheduledAd._adPodIndex=e.index+this.initialIndex,this.scheduledAd._adPodIndex>0&&this.triggerEvent(I))}impressionHandler(e){const t=this.getVastAd(),i=t.tracker,s=Object.assign({},this.scheduledAd,t),a=e.duration||t.duration||this.getDurationFromVideoTag(),r=this.player.getVolume()/100;i.impression(a,r),this.player.getViewable()?i.viewable():i.notViewable(),this.triggerEvent(B,_e(this.playlistItemManager,s,{duration:a,linear:e.linear||i.linear})),this.setupViewableListener()}viewableHandler(e){e.viewable?(this.viewablePlayedTime=0,this.lastPosition=null,this.adViewableImpressionHandler=this.adViewableHandler):this.adViewableImpressionHandler=this.player.utils.noop}bufferStartHandler(e){e.buffering=!0,e.trackOmidEvent("bufferStart")}bufferFinishHandler(e){e.buffering=!1,e.trackOmidEvent("bufferFinish")}stateHandler(e){const{oldstate:t,newstate:i}=e;if(i===t&&i!==a)return;const s="loading"===i||"stalled"===i,r=this.getVastAd().tracker;!s&&r.buffering?this.bufferFinishHandler(r):s&&r.started&&this.bufferStartHandler(r)}playHandler(e){clearTimeout(this.creativeTimeout),this.creativeTimeout=null;const t=this.getVastAd(),i=t.tracker;if(i.started)e.oldstate===s&&(i.resume(),this.dispatchPlay(e));else{this.vpaidPlayer&&(i.linear=e.linear),this.instreamPlayer&&this.impressionHandler({linear:i.linear});const s=Object.assign({},this.scheduledAd,t),r=_e(this.playlistItemManager,s,{linear:i.linear,metadata:!0});if(this.triggerEvent(q,r),t.companions){const e=_e(this.playlistItemManager,s,{companions:(a=t.companions,a.map((e=>{var t,i;const s="iframe"===e.type||"html"===e.type?e.type:"static";let a;return null!=e&&null!=(t=e.trackers)&&null!=(i=t.creativeView)&&i.length&&(a=e.trackers.creativeView),{width:e.width,height:e.height,type:s,resource:e.source,creativeview:a,click:e.clickthrough}})))});this.triggerEvent("adCompanions",e)}t.icons&&(t.iconInstances=t.icons.map((e=>new Et(this.player,e,this.div))));const n=this.companion;let l;l=this.player.utils.flashVersion()>9?t.companions:(e=>e?e.filter((e=>e.type.indexOf("flash")<0)):[])(t.companions),this.optionalParams.companion&&l&&l.length&&(i.hasComp=n.addCompanion(this.optionalParams.companion,l)),i.start(),i.creativeView(),this.dispatchPlay(e)}var a}pauseHandler(e){clearTimeout(this.creativeTimeout),this.creativeTimeout=null;var t;this.getVastAd().tracker.pause(),null===this.reason&&"vpaid"===this.adType&&(this.reason=p),0===this.position&&(t=this.player.play,It&&!It.Features.headless&&It.OS.iOS&&_t&&(t(),_t=!1)),this.setState(e)}remainingTimeHandler(e){e.duration?this.duration=e.duration:this.duration=Math.max(1,this.duration,e.remainingTime);const t=e.remainingTime>=0?this.duration-e.remainingTime:0;this.position===t?this.creativeTimeout=this.creativeTimeout||setTimeout((()=>{this.creativeAdError("Video stall",400)}),this.scheduledAd.creativeTimeout):this.creativeTimeout&&(clearTimeout(this.creativeTimeout),this.creativeTimeout=null),this.timeHandler({position:t,duration:this.duration,isDurationChange:e.isDurationChange})}quartileHandler(e){if(e.duration)this.duration=e.duration;else{const t=4*e.remainingTime/(4-e.quartile);this.duration=Math.max(this.duration,1,t)}this.timeHandler({position:this.duration*e.quartile*.25,duration:this.duration})}adViewableHandler(e){const{position:t}=e;null===this.lastPosition&&(this.lastPosition=t);let i=t-this.lastPosition;this.lastPosition=t,i=Math.min(Math.max(0,i),4),this.viewablePlayedTime+=i,this.viewablePlayedTime>=2&&(this.player.off(d,this.viewableHandler,this),this.adViewableImpressionHandler=this.player.utils.noop,this.triggerEvent("adViewableImpression",{}))}timeHandler(e){const t=this.getVastAd(),i=e.position,s=e.duration;this.adViewableImpressionHandler(e);const a=s-i,r=t.tracker;let n=this.optionalParams.dynamicMessage||"",l=this.optionalParams.podMessage||"";if(!this.player.getEnvironment().headless&&n&&a>0){var o;if(n=n.replace(/(\b)xx(s?\b)/gi,`$1${Math.ceil(a)}$2`),this.adPodItems&&this.adPodItems.length>1&&l){const e=this.scheduledAd._adPodIndex+1;l=l.replace(/__AD_POD_CURRENT__/g,`${e}`),l=l.replace(/__AD_POD_LENGTH__/g,`${this.adPodItems.length}`),n=`${l} ${n}`}this.instreamPlayer?this.instreamPlayer.setText(n):null!=this&&null!=(o=this.vpaidPlayer)&&o.instream&&this.vpaidPlayer.instream.setText(n)}if(e.isDurationChange)return;r&&r.time(i,s),t.iconInstances&&t.iconInstances.forEach((e=>{e.updateTime(i)}));const d={};d.position=this.position=i,d.duration=s,this.triggerEvent("adTime",d)}combinedCompleteHandler(){this.adCompleteHandler(),this.endOfAdBreakHandler()}adCompleteHandler(){clearTimeout(this.viewableTimeout);const e=this.getVastAd();St(e);const t=e.tracker;t.firedError||(t.complete(),this.triggerEvent(F))}adCloseHandler(){clearTimeout(this.viewableTimeout);const e=this.getVastAd().tracker;e.firedError||e.close()}adStartedHandler(){this.triggerEvent(H)}endOfVpaidAdHandler(){if(clearTimeout(this.viewableTimeout),this.adPodItems&&this.adPodItems.length-1>this.scheduledAd._adPodIndex)return this.vpaidPlayer&&(this.vpaidPlayer.destroy(),this.vpaidPlayer=null),this.scheduledAd._adPodIndex++,void this.playAd();this.endOfAdBreakHandler()}endOfAdBreakHandler(){this.removePlayerListeners(),this.trigger(T)}muteHandler(e){const t=this.getVastAd().tracker;t&&(e.mute?t.mute():t.unmute(),this.vpaidPlayer&&this.vpaidPlayer.setVolume(e.mute?0:this.player.getVolume()))}clickStaticHandler(){const e=this.getVastAd();this.player.pause({reason:h}),this.clickThrough(e)}clickVpaidHandler(e){const t=this.getVastAd();let i=!0;void 0!==(null==e?void 0:e.url)&&(!1===e.playerHandles&&(i=!1),t.clickthrough=e.url),this.clickThrough(t,i)}clickInstreamHandler(){var e,t;(this.instreamPlayer.getState()!==s||null!=(e=this.player)&&e.headless)&&this.clickThrough(this.getVastAd(),!(null!=(t=this.player)&&t.headless))}playbackErrorHandler(e){const t=e.message||"Error Playing Ad Tag";let i=e.code;i&&232404===i?i=403:(!i||i<=4||i>901)&&(i=405),this.vpaidPlayer&&"function"==typeof this.vpaidPlayer.off?(this.vpaidPlayer.off(),this.creativeAdError(t,i,e.adErrorCode)):this.adError(t,i,e.adErrorCode)}staticErrorHandler(){this.adError("Unable to fetch NonLinear resource",502)}vpaidExpandedHandler(e){const t=this.getVastAd().tracker;e.expanded?t.expand():t.collapse()}getDurationFromVideoTag(){const e=this.blockingInstreamPlayer?this.blockingInstreamPlayer.getMediaElement():null;return e?e.duration:0}setupViewableListener(){this.player.off(d,this.viewableHandler,this),this.player.on(d,this.viewableHandler,this),this.viewableHandler({viewable:this.player.getViewable()})}dispatchPlay(e){"static"===this.adType||"vpaid"===this.adType&&"linear"!==e.linear||(null===this.reason&&"vpaid"===this.adType&&(this.reason=p),this.setState(e))}setState({newstate:e,oldstate:t}){const i=e===a,s=this.adEventObject(i?U:Q);if(s.newstate=e,null!==this.reason){s[i?"playReason":"pauseReason"]=this.reason,this.reason=null}this.vpaidPlayer?(s.oldstate=t,this.vpaidPlayer.trigger("state",s)):this.instreamPlayer.setEventData(s)}clickThrough(e,t=!0){var i,s,a;e.tracker.click();const r={};e.clickthrough&&(r.clickThroughUrl=e.clickthrough),this.reason=h,this.triggerEvent(D,r),null!=(i=window)&&null!=(s=i.jwcast)&&null!=(a=s.player)&&a.id||e.clickthrough&&t&&window.open(e.clickthrough)}skipVpaidAd(){var e;null!=this&&null!=(e=this.vpaidPlayer)&&e.skip()&&this.vpaidAdSkipped()}vpaidAdSkipped(){this.adSkipped(),this.endOfVpaidAdHandler()}adSkipped(){clearTimeout(this.viewableTimeout);const e=this.getVastAd();e.tracker.skip(),St(e);const t="vpaid"===this.adType?void 0:this.getSkipOffset(e);this.triggerEvent(N,{duration:e.duration,skipoffset:t,position:this.position,watchedPastSkipPoint:this.position-t})}triggerEvent(e,t){const i=this.adEventObject(e);t&&Object.assign(i,t),this.trigger(e,i),-1===$.indexOf(e)&&this.player.trigger(e,i)}}const jt=e=>e.tag&&(void 0===e.podcount||1===e.sequence);class Ot extends ot{constructor(t,i,s,a,r,n,l){super(t,i,s,a,l),this.client=e,this.config=a,this.item=s,this.params=r,this.player=t,this.adPlayerProperties=n,this.logger=t.utils.logger.child("ads-vast/PlaylistItemManager"),this._vloaderQueue=[],this._events=[],this.adPlayerQueue=[],this.qoe=new t.utils.Timer,this.reason=null,this._debugTrackFn=a.debug&&a.trackFn?a.trackFn:null,Object.assign(this,t.Events)}init(e,t){const i=super.init(e,t);return this.vmapPromise&&this.vmapPromise.then((e=>{!this.isDestroyed()&&e&&e.length&&e.forEach((e=>{const i=Te(this,e,null,t);this.dispatchAdError(i)}))})).catch((e=>{if(this.isDestroyed())return;const i=Te(this,e,null,t);this.enqueueAdEvent(V,i,t)})),i}adPlayerImpressionHandler(e){jt(e)&&(this.qoe.tick(`adImpression${e.id}`),e.timeLoading=this.qoe.between("adBreakStart",`adImpression${e.id}`)),this.player.trigger(B,e)}playAdAPI(e){this.startBlocking(),Promise.resolve(e).then((()=>{if(!this.isDestroyed())return this.triggerAdBreakEvents(e),this.startAdBreak(e,{adBlock:this.adBlockErrorDetected,reason:c})})).catch((e=>this.isDestroyed()?null:this.dispatchFatalAdError(e)))}tryPlayAd(e,t){if(this.reason=t.reason||this.reason,this.dequeueAdEvents(),!e)return this.stopBlocking(),null;return"nonlinear"===e.scheduledAd()._type&&this.stopBlocking(),this.playAd(e).catch((i=>this.isDestroyed()?null:this.adWaterfall(e,i,t)))}playAd(e){const t=e.scheduledAd();0===t._waterfallIndex&&this.clearNonlinearAd(),this.removeVastLoader(e);return new Promise(((t,i)=>{const s=new Rt(e,this.player,this);s.on(T,t),s.on(V,i),s.on(B,this.adPlayerImpressionHandler.bind(this)),s.on(q,this.player.trigger),s.on(L,this.dispatchAdError.bind(this)),s.init(this.blockingInstreamPlayer,this.reason).catch((e=>this.logger.debug(e))),this.reason=null,this.adInstreamPlayer=this.blockingInstreamPlayer,this.blockingInstreamPlayer=null,this.adPlayerQueue.push(s)})).then((()=>{this.isDestroyed()||"nonlinear"===t._type||this.stopBlocking()}))}pause(e){if(this.adPlayerQueue.length){this.adPlayerQueue[this.adPlayerQueue.length-1].pause(e||{})}}resume(e){if(this.adPlayerQueue.length){this.adPlayerQueue[this.adPlayerQueue.length-1].play(e||{})}}skipAd(){if(this.adPlayerQueue.length){this.adPlayerQueue[this.adPlayerQueue.length-1].skip(),this.player.trigger(C)}}skipAdBreak(){var e,t,i;if(!this.schedule)return;const s=this.adPlayerQueue.length?this.adPlayerQueue[this.adPlayerQueue.length-1]:null;if(null!=s&&s.getState())return this.removeAdCue(s.scheduledAd),s.forceSkip(),void s.destroy();const a=this.player.getPosition();if(null!=(e=this.schedule)&&e.preRoll&&0===a)return this.removeAdCue(this.schedule.preRoll),void this.schedule.setPreRoll(null);const r=((null==(t=this.schedule)?void 0:t.midRolls)||[]).filter((e=>"nonlinear"!==e._type&&e._offsetSeconds>=a));if(r.length){const e=r[0];this.removeAdCue(e),this.schedule.midRolls.splice(this.schedule.midRolls.indexOf(e),1)}else null!=(i=this.schedule)&&i.postRoll&&(this.removeAdCue(this.schedule.postRoll),this.schedule.setPostRoll(null))}removeAdCue(e){const t=this.player.getCues();this.player.setCues(t.filter((t=>(null==t?void 0:t.adId)!==e.adBreakId)))}dispatchFatalAdError(e){e&&e.adErrorCode||(e=Te(this,{message:"An unexpected ad error has occurred",sourceError:e})),this.dequeueAdEvents(),this.dispatchAdError(e),this.destroyPlayers(),this.stopBlocking()}destroyPlayers(){this.adPlayerQueue.forEach((e=>e.destroy())),this.adPlayerQueue.splice(0)}dispatchAdError(e){jt(e)&&(this.qoe.tick(`adError${e.id}`),e.timeLoading=this.qoe.between("adBreakStart",`adError${e.id}`)),this.vmapTracker&&this.vmapTracker.error(e.code),50004!==e.adErrorCode&&50901!==e.adErrorCode||!this.player.getAdBlock()||(this.adBlockErrorDetected=!0);const t=70001===e.adErrorCode?"adWarning":V;this.player.trigger(t,e)}clearNonlinearAd(){if(this.adPlayerQueue.length){this.adPlayerQueue[this.adPlayerQueue.length-1].clearNonlinear()}}getVMAPTracker(e){if(!e._vmapTracker){const t=new At(e,e._trackers,this._debugTrackFn,this.player,this.config);e._vmapTracker=this.vmapTracker=t}return e._vmapTracker}_loadTag(e,t){const i=e._adQueue[e._waterfallIndex];return this._loadTagUrl(e,i,t)}_loadTagUrl(e,t,i){return Me(t,this.player,this.item,this.client,this.params,e).then((s=>{"function"==typeof this._debugTrackFn&&this._debugTrackFn({type:"tagReplacement",data:{actualTag:s,originalTag:t}});const a=this._createVastLoader(e,i),r=a.load(s);return i.isPodItemLoader?i.tagIndex&&(a.scheduledAd().adRequestIds[i.tagIndex]=this.player.utils.genId(12)):e._currentTag=s,this._dispatchAdRequest(e,Object.assign({tag:s},i)),r}))}_loadPods(e,t){e.adRequestIds=[];const i=this._createVastLoader(e,t),s=e._pod.map(((i,s)=>{const a=Object.assign({tag:i,isPodItemLoader:!0,tagIndex:s},t),r=this._loadTagUrl(e,i,a).catch((e=>(e.tagIndex=s,Promise.reject(e)))),n=()=>this.isDestroyed()?null:this._dispatchAdLoaded(e,a);return r.then(n).catch((e=>this.logger.debug(e))),r.catch(n).catch((e=>this.logger.debug(e))),r}));return i.podMultipleVastLoaders(s)}_loadXML(e,t){e._currentTag=e._currentTag||e._adXML.toString();return this.bidsPromise.then((()=>(this._dispatchAdRequest(e,t),this._createVastLoader(e,t).parseVast(e._adXML,e._currentTag))))}_dispatchAdRequest(e,t){const{skipoffset:i}=this.config,s=_e(this,e,Object.assign({jwpseg:e.jwpseg},t));i>=0&&(s.skipoffset=i),this.player.trigger("adRequest",s),this.qoe.tick(`adLoading${s.id}`)}_dispatchAdLoaded(e,t){const i=_e(this,e,t),s=i.id;this.qoe.tick(`adLoaded${s}`),i.timeLoading=this.qoe.between(`adLoading${s}`,`adLoaded${s}`),this.player.trigger("adLoaded",i)}_handleVastLoadError(e,t,i){const s=e.vloader;return this.removeVastLoader(s),this._getVloaderErrorObject(e,t,i)}_vloaderWaterfall(e,t){const i=this._handleVastLoadError(e,null,t),s=e.vloader;return this.adWaterfall(s,i,t)}adWaterfall(e,t,i){const s=e.scheduledAd();if(this.schedule.canWaterfall(s))return s.jwpseg=null,s._adXML=null,s._waterfallIndex+=1,this.enqueueAdEvent(V,t,i),this.startAdBreak(s,i);throw t}_createVastLoader(e,t={}){const i=this.config,s=new wt(e,this.player,Object.assign({requestFilter:i.requestFilter,trackingFilter:i.trackingFilter,item:this.item,params:this.params},t));this._vloaderQueue.push(s);let a=0;return s.on(L,(i=>{a+=1;const r=this._getVloaderErrorObject(i,null,t);this.enqueueAdEvent(V,r,t);if(!(s._scheduledAd._pod&&s._scheduledAd._pod.length===a)){const i=_e(this,e,{podIndex:s._scheduledAd._adPodIndex,tagIndex:a});this.enqueueAdEvent(I,i,t)}}),this),s.on(E,(e=>{this.player.trigger(E,Object.assign(_e(this,null),e))})),s}_getVloaderErrorObject(e,t,i){e.wrapperAdSystem&&e.wrapperAdSystem.length!==e.wrappedTags.length&&(e.wrapperAdSystem.push(e.adsystem),e.adsystem="");const s=Object.assign({adsystem:e.adsystem,wrapper:e.wrapperAdSystem,wrappedTags:e.wrappedTags},e.vloader.scheduledAd());return Te(this,e,s,Object.assign({tag:e.tag,tagIndex:e.tagIndex||t,podIndex:e.podIndex},Object.assign({jwpseg:s.jwpseg},i)))}dequeueAdEvents(){this._events.forEach((({type:e,event:t})=>{e===V?this.dispatchAdError(t):this.player.trigger(e,t)})),this._events.splice(0)}triggerAdBreakEvents(e){const t=this.getVMAPTracker(e);this.blockingInstreamPlayer.once("destroyed",(()=>{this.qoe.clear("adBreakStart"),t.breakEnd(),this.player.trigger("adBreakEnd",_e(this,e))}),this),this.qoe.tick("adBreakStart"),t.breakStart();const i=_e(this,e);this.player.trigger("adBreakStart",i),this.player.trigger(I,i)}startBlocking(){this.blockingInstreamPlayer||(!function(e){if(It=e.getEnvironment(),!It||It.Features||It.Features.headless||!It.OS.iOS||It.Browser.version.major<10)return;const t=e.getContainer();t.requestFullscreen||t.webkitRequestFullscreen||e.getFullscreen()&&(e.setFullscreen(!1),_t=!0)}(this.player),this.blockingInstreamPlayer=this.player.createInstream().init(),this.blockingInstreamPlayer.adPlayPromise&&this.waitForAdPlay(this.blockingInstreamPlayer.adPlayPromise))}stopBlocking(){if(this.blockingInstreamPlayer||this.adInstreamPlayer){const e=this.blockingInstreamPlayer||this.adInstreamPlayer;this.blockingInstreamPlayer=null,e.destroy(),this.player.trigger(C)}this.adInstreamPlayer=null}loadAd(e,t={}){const i=this.player.utils;if(e._id=e._id||i.genId(12),e._vmapTracker=this.getVMAPTracker(e),!e._adQueue&&!e._adXML&&!e._pod)return void this.logger.warn("scheduled ad has no url or xml",e);if(t.adBlock)throw Te(this,{message:"Ad playback blocked by an ad blocker",adErrorCode:600003},e,t);let s;if(e._pod)return this._loadPods(e,t);s=e._adXML?this._loadXML(e,t):this._loadTag(e,t);const a=()=>this.isDestroyed()?null:this._dispatchAdLoaded(e,t);return s.then(a).catch((e=>this.logger.debug(e))),s.catch(a).catch((e=>this.logger.debug(e))),s.catch((e=>this.isDestroyed()?null:this._vloaderWaterfall(e,t)))}playPreloadedPromise(e,t={}){e.then((e=>this.tryPlayAd(e,t))).catch((e=>{this.isDestroyed()||(this.dispatchAdError(e),this.stopBlocking())}))}startAdBreak(e,t={}){((e,t)=>{var i;let s;if(null!=e&&null!=(i=e._adQueue)&&i[0]){try{s=new URL(e._adQueue[0],window.location).protocol}catch(e){t.utils.logger.debug(e)}"https:"!==s&&"https:"===window.location.protocol&&t.trigger(b,{message:"VPAID insecure request was blocked.",code:901,adErrorCode:50005})}})(e,this.player);return this.bidsPromise.then((()=>this.loadAd(e,t))).then((e=>this.tryPlayAd(e,t))).catch((e=>{this.dispatchAdError(e),this.stopBlocking()}))}removeVastLoader(e){const t=this._vloaderQueue.indexOf(e);-1!==t&&(e.destroy(),this._vloaderQueue.splice(t,1))}isDestroyed(){return null===this.player}destroy(){this._vloaderQueue.forEach((e=>e.destroy())),this.clearNonlinearAd(),this.destroyPlayers(),this.stopBlocking(),super.destroy()}}class Mt{constructor(e,t,i){this.player=e,this.pluginConfig=t,this.adClient=i;const s=this.configParser=new nt(e.utils),a=this.adRules=new lt(e,s.getAdRules(t),i);this.emptySchedule=new it(a,e.utils),this.logger=this.player.utils.logger.child("ads-shared/ConfigScheduleParser")}getAdRules(){return this.adRules}resetDefaultSchedule(e){const t=void 0===this.pluginConfig.withCredentials||this.pluginConfig.withCredentials,i=this.defaultSchedule=this.configParser.getSchedule(this.pluginConfig,this.adRules);i.isVMAP()&&i.load(this.player,e,this.adClient,{withCredentials:t}).catch((e=>this.logger.debug(e)))}getSchedule(e,t){var i;return t>0&&!this.adRules.rulesAllowAdPlayback(t)?this.emptySchedule:null!=e&&e.adschedule&&!0!==(null==(i=this.pluginConfig)?void 0:i.ignorePlaylistSchedules)?this.configParser.getSchedule(e,this.adRules):(this.resetDefaultSchedule(e),this.defaultSchedule)}getOptParams(e,t){return this.configParser.getOptParams(e,t)}reset(){this.adRules.reset()}destroy(){this.emptySchedule&&this.emptySchedule.destroy(),this.defaultSchedule&&this.defaultSchedule.destroy()}}const Bt={},Vt={},Lt={},Ht=(e,t)=>{const i=Bt[t];return i||(Bt[t]=new Promise(((i,s)=>{const a=new e.key(t);if("unlimited"===a.edition())return s();const r=["//","entitlements.jwplayer.com","/",a.token(),".json"];"file:"===window.location.protocol&&r.unshift("https:"),e.ajax(r.join(""),(function(e){const t=null==e?void 0:e.response;t?i(t):s()}),(function(){s()}),{timeout:1e4,responseType:"json"})})))},Ft=(e,t)=>{const i=Vt[t];return i||(Vt[t]=Ht(e,t).catch((()=>({}))).then((e=>{if(!1===e.canUseVPB)throw new Error("Not entitled for Player Bidding")})))},Dt=(e,t,i)=>{const s=Lt[t];return s||(Lt[t]=Ht(e,t).catch((()=>({}))).then((e=>{let t,s;if(!0===i.outstream?(t=!1!==e.canPlayOutstreamAds,s="Outstream Ad Limit Reached"):(t=!1!==e.canPlayAds,s="Ad Limit Reached"),!1===t)throw new Error(s);return{message:"Can Play Ads"}})))};var Nt="8.11.0";const qt=function(){};!function(e){if(e&&"undefined"!=typeof window){var t=document.createElement("style");t.setAttribute("media","screen"),t.innerHTML=e,document.head.appendChild(t)}}(".jwplayer.jw-flag-time-slider-above .jw-vpaid-non-linear{bottom:66px}.jwplayer.jw-breakpoint-7 .jw-vpaid-non-linear{bottom:132px}.jwplayer.jw-flag-user-inactive:not(.jw-state-paused) .jw-vpaid-non-linear{bottom:.5em}.jwplayer .jw-vpaid-non-linear{bottom:60px}.jwplayer .jw-vpaid-iframe{border:0;width:100%;height:100%;position:absolute;overflow:hidden}.jwplayer .jw-plugin-vast.jw-plugin{top:0;width:100%;pointer-events:none}.jwplayer .jw-plugin-vast.jw-plugin *{pointer-events:all}.jwplayer .jw-plugin-vast .jw-ad-icon-container{position:absolute;display:none;pointer-events:all;cursor:pointer}.jwplayer .jw-plugin-vast .jw-ad-icon-container.jw-ad-icon-active{display:block}.jwplayer .jw-plugin-vast .jw-ad-icon-container iframe{pointer-events:none;border:none;height:100%;width:100%;margin:0}.jw-plugin-vast.jw-vast-nonlinear-active .jw-banner{opacity:1}.jw-plugin-vast.jw-vast-nonlinear-active .jw-vast-nonlinear-close-button{margin:0 auto;opacity:.75}.jw-plugin-vast.jw-vast-nonlinear-active:hover .jw-vast-nonlinear-close-button{opacity:1}.jw-plugin-vast.jw-vast-nonlinear-collapsed .jw-vast-nonlinear-open-button{margin:0 auto;opacity:.5}.jw-plugin-vast.jw-vast-nonlinear-collapsed .jw-banner,.jw-plugin-vast.jw-vast-nonlinear-collapsed .jw-vast-nonlinear-close-button{opacity:0}.jw-plugin-vast.jw-vast-nonlinear-collapsed:hover .jw-vast-nonlinear-open-button{opacity:1}.jw-plugin-vast.jw-vast-nonlinear-collapsed:hover .jw-vast-nonlinear-close-button{opacity:0}.jw-plugin-vast .jw-vast-nonlinear-close-button,.jw-plugin-vast .jw-vast-nonlinear-open-button{position:absolute;right:0;bottom:0;left:0;display:block;margin:auto;width:18px;height:18px;cursor:pointer;opacity:0;transition:opacity .2s ease}.jw-plugin-vast .jw-vast-nonlinear-close-button{transform:rotate(45deg)}"),function(e,t,i){try{(window.jwplayerPluginJsonp||window.jwplayer().registerPlugin)(e,t,i)}catch(e){}}(e,"8.1",class extends z{constructor(t,i,s){super(t,i,s,e),this.configScheduleParser=new Mt(this.player,this.pluginConfig,e),this.environment=this.player.getEnvironment(),this.debugTrackFn=this.pluginConfig.debug&&this.pluginConfig.trackFn?this.pluginConfig.trackFn:null;const a=void 0===this.pluginConfig.withCredentials||this.pluginConfig.withCredentials;this.optionalParams={withCredentials:a},this.nextPlaylistItemManager=null,this.nextPlaylistRelated=!1,this.adPlayerProperties=null,this.playlistItemEventCount=0,this.logger=t.utils.logger.child("ads-vast/vastPlugin"),this.bidsBlock=null,(e=>{try{const t=e.settings.mediationLayerAdServer||"jwp",i=Boolean(e.bidders.length);return("jwp"===t||"jwpspotx"===t)&&i}catch(e){return!1}})(this.pluginConfig.bids)&&(this.bidsBlock=Object.assign({},this.pluginConfig.bids)),function(e,t,i,s){const a=t.key,r=e.utils,n=Dt(r,a,i),l=r.logger.child("ads-shared/checkEntitlements");let o;n.catch((e=>l.debug(e))),i.bids&&(o=Ft(r,a),o.catch((e=>l.debug(e)))),e.on("ready",(()=>{o&&o.catch((i=>{e.trigger("destroyBidding"),e.trigger(b,xe(i.message,60009,t,s))})),n.catch((i=>{e.trigger("destroyPlugin",i),e.trigger(b,xe(i.message,60002,t,s))}))}))}(this.player,this.playerConfig,this.pluginConfig,e),"enabled"===this.pluginConfig.omidSupport&&ft(this.utils).catch((e=>this.logger.debug(e))),this.version=Nt,Object.assign(this,this.player.Events),this.div&&this.utils.addClass(this.div,"jw-plugin-vast"),this.player.on({ready:this.onReady,cast:this.castHandler,play:this.dispatchPlaying,playlistItem:this.onPlaylistItemCallback,playlistComplete:this.reset,complete:this.playerComplete,destroyPlugin:this.reset,destroyBidding:this.destroyBidding},this),this.makeBaseAdObject=()=>{const e=0===this.optionalParams.requestTimeout?1/0:this.optionalParams.requestTimeout,t=0===this.optionalParams.creativeTimeout?1/0:this.optionalParams.creativeTimeout;return{_id:this.utils.genId(12),_waterfallIndex:0,_adPodIndex:0,adBreakId:this.utils.genId(12),_offset:0,_position:Ie(this.player,!0),requestTimeout:e||f,creativeTimeout:t||15e3}},this.player.loadAdTag=e=>{const t=this.makeBaseAdObject();Array.isArray(e)?t._adQueue=e.slice(0):t._adQueue=[e],this.loadAdObj(t)},this.player.playAd=this.player.loadAdTag,this.player.loadAdXml=e=>{const t=this.makeBaseAdObject();t._adXML=e,this.loadAdObj(t)},this.player.loadAdBreak=e=>null!=e&&e.adTag?this.player.loadAdTag(e.adTag):null!=e&&e.adXml?this.player.loadAdXml(e.adXml):void 0,this.loadAdObj=e=>{this.playlistItemManager?(this.playlistItemManager.clearNonlinearAd(),this.playlistItemManager.playAdAPI(e)):this.player.once("playlistItem",(()=>this.playlistItemManager.playAdAPI(e)),this)},this.player.pauseAd=this.pauseAd.bind(this),this.player.isReady()&&this.lateInitAfterReady()}pauseAd(e,t=null){e="boolean"!=typeof e||e,super.pauseAd(e,t)}reset(e){this.playlistItemManager&&(e&&(this.nextPlaylistItemManager=this.playlistItemManager.next,this.nextPlaylistRelated=this.playlistItemManager.nextPlaylistRelated),this.playlistItemManager.schedule.reset(),this.playlistItemManager.off(null,null,this),this.playlistItemManager.destroy(),this.playlistItemManager=null),this.configScheduleParser.reset(),function(e){const t=e.getCues();if(Array.isArray(t)&&t.length){const i=t.filter((e=>"ads"!==e.cueType));e.setCues(i)}}(this.player)}destroy(){if(this.playlistItemManager&&(this.playlistItemManager.schedule.reset(),this.playlistItemManager.off(null,null,this),this.playlistItemManager.destroy(),this.playlistItemManager=null),this.nextPlaylistItemManager&&(this.nextPlaylistItemManager.schedule.reset(),this.nextPlaylistItemManager.off(null,null,this),this.nextPlaylistItemManager.destroy(),this.nextPlaylistItemManager=null),this.configScheduleParser.destroy(),this.adPlayerProperties){const e=this.adPlayerProperties.staticPlayer;e&&e.destroy()}this.player.loadAdTag=qt,this.player.playAd=qt,this.player.loadAdXml=qt,this.player.pauseAd=qt,this.player.off(null,null,this)}destroyBidding(){this.bidsBlock=null}playerComplete(){this.playlistItemManager&&this.playlistItemManager.clearNonlinearAd()}setupPlaylistItemManager(e,t,i){const s=this.configScheduleParser.getSchedule(e,t),a=new Ot(this.player,s,e,this.pluginConfig,i,this.adPlayerProperties,this.casting);return a.init(this.bidsBlock,i).then((()=>{a.isDestroyed()||this.player.trigger("adSchedule",_e(a,null,{schedule:s}))})).catch((e=>this.logger.debug(e))),a.on("preloadNext",(e=>{const t=Object.assign({},i,{preloadPreroll:!0,playlistItemEventCount:this.playlistItemEventCount+1});a.next=this.setupPlaylistItemManager(e.item,t.playlistItemEventCount,t)})),a}onPlaylistItemCallback(e){this.handlePlaylistItem(e)}handlePlaylistItem(e){this.playlistItemEventCount+=1,this.reset(!0);const t=this.player.getPlaylistItem(e.index);var i;(this.nextPlaylistItemManager&&t!==this.nextPlaylistItemManager.item&&!this.nextPlaylistRelated&&(this.nextPlaylistItemManager.off(null,null,this),this.nextPlaylistItemManager.destroy(),this.nextPlaylistItemManager=null,this.nextPlaylistRelated=!1),this.optionalParams.playlistItemEventCount=this.playlistItemEventCount,this.playlistItemManager=this.nextPlaylistItemManager||this.setupPlaylistItemManager(t,this.playlistItemEventCount,this.optionalParams),this.playlistItemManager.attachListeners(),this.nextPlaylistItemManager=null,this.nextPlaylistRelated=!1,this.playlistItemManager.schedule.isVMAP())?this.playlistItemManager.vmapPromise.then((()=>{var e;this.playlistItemManager.isDestroyed()||this.sendCues(this.playlistItemManager.schedule,null==(e=this.optionalParams)?void 0:e.cuetext)})).catch((e=>this.logger.debug(e))):this.sendCues(this.playlistItemManager.schedule,null==(i=this.optionalParams)?void 0:i.cuetext)}castHandler(e){this.casting=Boolean(e.active)}dispatchPlaying(e){this.trigger(a,e)}onReady(){this.playerConfig.localization=this.player.getConfig().localization,this.optionalParams=this.configScheduleParser.getOptParams(this.pluginConfig,this.playerConfig.localization.advertising),this.optionalParams.debugTrackFn=this.debugTrackFn,this.adPlayerProperties=Object.assign({companion:new G(this.debugTrackFn,this.environment,{openLink:this.utils.openLink,scriptloader:this.utils.scriptloader}),div:this.div,optionalParams:this.optionalParams},this.environment.headless?{}:{staticPlayer:new te(this.player,this.div)})}})}();
